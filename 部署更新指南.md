# 部署更新指南

## 方式一：使用更新脚本（推荐）

### 1. 上传文件到服务器
```bash
# 使用你的SSH方式上传以下两个文件到服务器
scp deploy-packages/design-institute-platform_20251112_101700.tar.gz root@58.209.247.194:~/
scp update-deployment.sh root@58.209.247.194:~/
```

### 2. 在服务器上执行更新
```bash
ssh root@58.209.247.194
chmod +x update-deployment.sh
sudo ./update-deployment.sh ~/design-institute-platform_20251112_101700.tar.gz
```

## 方式二：手动更新步骤

### 1. 上传并解压
```bash
# 在服务器上
cd ~
tar -xzf design-institute-platform_20251112_101700.tar.gz
cd design-institute-platform_*
```

### 2. 停止服务
```bash
cd /opt/design-institute-platform/apps/api
pm2 stop api
pm2 stop doc-recognition
pm2 stop vector-service
```

### 3. 备份环境变量
```bash
cp /opt/design-institute-platform/apps/api/.env ~/api.env.backup
cp /opt/design-institute-platform/services/document-recognition/.env ~/doc.env.backup
cp /opt/design-institute-platform/services/vector-service/.env ~/vector.env.backup
```

### 4. 更新代码
```bash
# 更新前端
rm -rf /opt/design-institute-platform/apps/web/dist
cp -r ~/design-institute-platform_*/apps/web/dist /opt/design-institute-platform/apps/web/

# 更新后端（保留node_modules和uploads）
rsync -av --exclude='node_modules' --exclude='uploads' --exclude='logs' \
  ~/design-institute-platform_*/apps/api/ \
  /opt/design-institute-platform/apps/api/

# 更新Python服务
rsync -av --exclude='__pycache__' \
  ~/design-institute-platform_*/services/ \
  /opt/design-institute-platform/services/
```

### 5. 恢复环境变量
```bash
cp ~/api.env.backup /opt/design-institute-platform/apps/api/.env
cp ~/doc.env.backup /opt/design-institute-platform/services/document-recognition/.env
cp ~/vector.env.backup /opt/design-institute-platform/services/vector-service/.env
```

### 6. 安装新依赖并迁移数据库
```bash
cd /opt/design-institute-platform/apps/api
npm install --production
npx knex migrate:latest
```

### 7. 重启服务
```bash
pm2 restart api
pm2 restart doc-recognition
pm2 restart vector-service
```

### 8. 验证服务
```bash
pm2 list
pm2 logs api --lines 50
curl http://localhost:3000/health
```

## 更新脚本特性

✅ **自动备份** - 自动备份当前版本（不含node_modules/uploads）
✅ **保留数据** - 保留环境变量、上传文件、日志
✅ **零停机** - 只在必要时停止服务
✅ **自动迁移** - 自动运行数据库迁移
✅ **回滚支持** - 备份文件可用于快速回滚

## 注意事项

1. **环境变量不会被覆盖** - 脚本会保留现有.env文件
2. **上传文件保留** - uploads目录内容不会丢失
3. **依赖自动更新** - 会检查并安装新的npm包
4. **数据库自动迁移** - 自动运行未执行的迁移文件
5. **备份位置** - `/opt/backups/backup_时间戳.tar.gz`

## 回滚操作

如果更新出现问题，使用备份回滚：

```bash
cd /opt/design-institute-platform
pm2 stop all
tar -xzf /opt/backups/backup_YYYYMMDD_HHMMSS.tar.gz
pm2 restart all
```

## 常见问题

### 服务启动失败
```bash
# 查看日志
pm2 logs api --lines 100

# 检查端口占用
lsof -i :3000

# 重启服务
pm2 restart api
```

### 数据库连接失败
```bash
# 检查环境变量
cat /opt/design-institute-platform/apps/api/.env | grep DB_

# 测试数据库连接
psql -h localhost -U postgres -d design_institute_platform
```

### Python服务错误
```bash
# 查看Python服务日志
pm2 logs doc-recognition --lines 100

# 检查Python依赖
cd /opt/design-institute-platform/services/document-recognition
pip3 list
```
