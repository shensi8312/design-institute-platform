# ç»Ÿä¸€è§„åˆ™ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ

**è®¾è®¡æ—¥æœŸ**: 2025-11-06
**è®¾è®¡ç›®æ ‡**: æ„å»ºå¯æ‰©å±•çš„ç»Ÿä¸€è§„åˆ™å­¦ä¹ ã€ç®¡ç†å’Œåº”ç”¨ç³»ç»Ÿ

---

## 1. è®¾è®¡ç›®æ ‡

### 1.1 ä¸šåŠ¡ç›®æ ‡
- **è£…é…è§„åˆ™**: ä»STEPæ–‡ä»¶å­¦ä¹ é›¶ä»¶è£…é…çº¦æŸï¼Œç”¨äº3Dè‡ªåŠ¨è£…é…
- **PIDè§„åˆ™**: ä»P&IDå›¾çº¸å­¦ä¹ ç®¡é“ä»ªè¡¨è¿æ¥è§„åˆ™ï¼Œç”¨äºå·¥è‰ºè®¾è®¡
- **å»ºç­‘è§„èŒƒ**: ä»GB/JGJç­‰æ–‡æ¡£æå–è®¾è®¡è§„èŒƒï¼Œç”¨äºåˆè§„æ£€æŸ¥
- **å·¥è‰ºè§„åˆ™**: åˆ¶é€ ã€ææ–™ã€æˆæœ¬ç­‰ä¸šåŠ¡è§„åˆ™ï¼ˆäºŒæœŸï¼‰

### 1.2 æŠ€æœ¯ç›®æ ‡
- ç»Ÿä¸€çš„è§„åˆ™å­¦ä¹ æµç¨‹ï¼ˆå¯æ’æ‹”ä¸šåŠ¡é€»è¾‘ï¼‰
- ç»Ÿä¸€çš„å®¡æ ¸ç®¡ç†ç•Œé¢
- ç»Ÿä¸€çš„åº”ç”¨åé¦ˆæœºåˆ¶
- Human-in-the-Loopå­¦ä¹ é—­ç¯

---

## 2. æ ¸å¿ƒæ¶æ„

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ç»Ÿä¸€ç•Œé¢                           â”‚
â”‚  [è§„åˆ™å­¦ä¹ é…ç½®] [è§„åˆ™å®¡æ ¸ä¸­å¿ƒ] [è§„åˆ™åº“ç®¡ç†] [åº”ç”¨ç›‘æ§]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç»Ÿä¸€è§„åˆ™å¼•æ“å±‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å­¦ä¹ è°ƒåº¦å™¨    â”‚  â”‚  å®¡æ ¸å·¥ä½œæµ   â”‚  â”‚  åº”ç”¨å¼•æ“    â”‚  â”‚
â”‚  â”‚ (å¯é…ç½®è§¦å‘)  â”‚  â”‚ (ä¸€æœŸ:ç®€å•)  â”‚  â”‚ (ç½®ä¿¡åº¦+äººå·¥)â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ä¸šåŠ¡è§„åˆ™å¤„ç†å™¨ï¼ˆå¯æ’æ‹”ï¼‰                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚è£…é…è§„åˆ™å¤„ç†å™¨â”‚ â”‚PIDè§„åˆ™å¤„ç†å™¨â”‚ â”‚å»ºç­‘è§„åˆ™å¤„ç†å™¨â”‚         â”‚
â”‚  â”‚- STEPåˆ†æ  â”‚ â”‚- OCRæå–   â”‚ â”‚- LLMæå–   â”‚          â”‚
â”‚  â”‚- çº¦æŸæ¨ç†  â”‚ â”‚- ç¬¦å·è¯†åˆ«  â”‚ â”‚- æ¡æ–‡è§£æ  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®æŒä¹…å±‚                            â”‚
â”‚  rule_base (é€šç”¨å­—æ®µ)                                    â”‚
â”‚  â”œâ”€ assembly_rules (è£…é…çº¦æŸ)                            â”‚
â”‚  â”œâ”€ pid_rules (ç®¡é“ä»ªè¡¨)                                 â”‚
â”‚  â””â”€ building_rules (å»ºç­‘è§„èŒƒ)                            â”‚
â”‚  rule_applications (åº”ç”¨è®°å½• - åé¦ˆå­¦ä¹ )                 â”‚
â”‚  rule_learning_config (å­¦ä¹ é…ç½®)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 åŸºè¡¨ï¼šrule_base

```sql
CREATE TABLE rule_base (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  rule_type VARCHAR(50) NOT NULL,  -- 'assembly' | 'pid' | 'building' | 'process'
  name VARCHAR(200) NOT NULL,
  description TEXT,

  -- æ¥æºè¿½æº¯
  source_type VARCHAR(50),  -- 'step_file' | 'drawing' | 'document' | 'manual'
  source_file_id UUID REFERENCES knowledge_documents(id),
  source_metadata JSONB,  -- åŸå§‹æ–‡ä»¶ä¿¡æ¯

  -- å­¦ä¹ ä¸å®¡æ ¸
  extraction_method VARCHAR(50),  -- 'ai_learning' | 'llm_extraction' | 'manual'
  confidence_score DECIMAL(3,2),  -- 0.00-1.00
  review_status VARCHAR(20) DEFAULT 'pending',  -- 'pending' | 'approved' | 'rejected'
  reviewed_by UUID REFERENCES users(id),
  reviewed_at TIMESTAMP,
  review_comment TEXT,

  -- åº”ç”¨ç»Ÿè®¡ï¼ˆç”¨äºåé¦ˆå­¦ä¹ ï¼‰
  usage_count INTEGER DEFAULT 0,
  success_count INTEGER DEFAULT 0,
  last_applied_at TIMESTAMP,

  -- é€šç”¨å­—æ®µ
  is_active BOOLEAN DEFAULT TRUE,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX idx_rule_type (rule_type),
  INDEX idx_review_status (review_status),
  INDEX idx_confidence (confidence_score DESC)
);
```

### 3.2 ä¸šåŠ¡è¡¨ï¼šassembly_rules

```sql
CREATE TABLE assembly_rules (
  rule_id UUID PRIMARY KEY REFERENCES rule_base(id) ON DELETE CASCADE,

  -- è£…é…çº¦æŸç±»å‹
  constraint_type VARCHAR(50) NOT NULL,  -- 'mate' | 'align' | 'offset' | 'angle' | 'pattern'

  -- çº¦æŸå®ä½“
  entities JSONB NOT NULL,  -- [{"part": "A", "face": "top"}, {"part": "B", "face": "bottom"}]

  -- çº¦æŸå‚æ•°
  parameters JSONB,  -- {"offset": 10, "angle": 90, "unit": "mm"}

  -- æ¨ç†è·¯å¾„
  reasoning_path TEXT,  -- AIæ¨ç†è¿‡ç¨‹è¯´æ˜

  -- å‡ ä½•ç‰¹å¾
  geometric_features JSONB,  -- ä»STEPæå–çš„å‡ ä½•ç‰¹å¾

  -- ä¼˜å…ˆçº§
  priority INTEGER DEFAULT 5,  -- 1-10, æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜

  -- å†²çªæ£€æµ‹
  conflicts_with UUID[],  -- ä¸å“ªäº›è§„åˆ™å†²çª

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.3 ä¸šåŠ¡è¡¨ï¼špid_rules

```sql
CREATE TABLE pid_rules (
  rule_id UUID PRIMARY KEY REFERENCES rule_base(id) ON DELETE CASCADE,

  -- PIDè§„åˆ™ç±»å‹
  rule_category VARCHAR(50),  -- 'symbol' | 'connection' | 'specification' | 'layout'

  -- ç¬¦å·è¯†åˆ«
  symbol_type VARCHAR(100),  -- 'valve' | 'pump' | 'instrument' | ...
  symbol_variants JSONB,  -- ä¸åŒè¡¨ç¤ºæ–¹å¼

  -- è¿æ¥è§„åˆ™
  connection_rules JSONB,  -- {"inlet": "pipe", "outlet": "pipe", "control": "signal"}

  -- è§„æ ¼å‚æ•°
  specifications JSONB,  -- {"pressure": "PN16", "material": "SS304", ...}

  -- å¸ƒå±€çº¦æŸ
  layout_constraints JSONB,  -- é—´è·ã€æ–¹å‘ç­‰

  -- æ ‡å‡†å¼•ç”¨
  standard_reference VARCHAR(200),  -- å¦‚ "GB/T 12459-2017"

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.4 ä¸šåŠ¡è¡¨ï¼šbuilding_rules

```sql
CREATE TABLE building_rules (
  rule_id UUID PRIMARY KEY REFERENCES rule_base(id) ON DELETE CASCADE,

  -- è§„èŒƒç¼–ç 
  standard_code VARCHAR(100) NOT NULL,  -- "GB50809-2023-4.2.1"
  standard_name VARCHAR(200),  -- "æ•°æ®ä¸­å¿ƒè®¾è®¡è§„èŒƒ"

  -- è§„åˆ™å†…å®¹
  article_number VARCHAR(50),  -- "4.2.1"
  article_title VARCHAR(200),
  rule_text TEXT NOT NULL,  -- è§„èŒƒåŸæ–‡

  -- ç»“æ„åŒ–å‚æ•°
  rule_parameters JSONB,  -- {"minHeight": 2.8, "unit": "m", "condition": "ä¸»æœºæˆ¿"}

  -- é€‚ç”¨èŒƒå›´
  applicable_scope VARCHAR(200),
  building_type VARCHAR(100),  -- "data_center" | "residential" | ...

  -- å¼ºåˆ¶ç­‰çº§
  compliance_level VARCHAR(20),  -- 'mandatory' | 'recommended' | 'optional'

  -- æ£€æŸ¥æ–¹æ³•
  check_method VARCHAR(50),  -- 'dimension' | 'material' | 'calculation' | ...
  check_logic JSONB,  -- æ£€æŸ¥é€»è¾‘çš„æœºå™¨å¯è¯»æ ¼å¼

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.5 åº”ç”¨è®°å½•è¡¨ï¼ˆåé¦ˆå­¦ä¹ æ ¸å¿ƒï¼‰

```sql
CREATE TABLE rule_applications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  rule_id UUID REFERENCES rule_base(id) ON DELETE CASCADE,

  -- åº”ç”¨åœºæ™¯
  application_type VARCHAR(50),  -- 'assembly_generation' | 'pid_design' | 'compliance_check'
  project_id UUID,
  design_id UUID,

  -- åº”ç”¨ä¸Šä¸‹æ–‡
  context JSONB,  -- å½“æ—¶çš„è¾“å…¥æ•°æ®ï¼ˆå¦‚é›¶ä»¶ä¿¡æ¯ã€å›¾çº¸ç‰¹å¾ç­‰ï¼‰

  -- åº”ç”¨æ–¹å¼
  applied_method VARCHAR(50),  -- 'auto' | 'suggested' | 'manual_selected'

  -- ç»“æœè¯„ä¼°
  result_status VARCHAR(20),  -- 'success' | 'failed' | 'corrected' | 'rejected'

  -- äººå·¥åé¦ˆ
  user_feedback VARCHAR(20),  -- 'correct' | 'incorrect' | 'partially_correct'
  user_correction JSONB,  -- ç”¨æˆ·ä¿®æ­£åçš„æ­£ç¡®ç­”æ¡ˆ
  feedback_comment TEXT,

  -- ç½®ä¿¡åº¦è°ƒæ•´
  original_confidence DECIMAL(3,2),
  adjusted_confidence DECIMAL(3,2),  -- æ ¹æ®åé¦ˆè°ƒæ•´åçš„ç½®ä¿¡åº¦

  applied_by UUID REFERENCES users(id),
  applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX idx_rule_id (rule_id),
  INDEX idx_result_status (result_status),
  INDEX idx_applied_at (applied_at DESC)
);
```

### 3.6 å­¦ä¹ é…ç½®è¡¨

```sql
CREATE TABLE rule_learning_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  rule_type VARCHAR(50) NOT NULL,  -- 'assembly' | 'pid' | 'building'

  -- å­¦ä¹ è§¦å‘æ–¹å¼
  trigger_mode VARCHAR(50),  -- 'auto' | 'manual' | 'batch' | 'scheduled'

  -- è‡ªåŠ¨å­¦ä¹ é…ç½®
  auto_learn_enabled BOOLEAN DEFAULT FALSE,
  auto_approve_threshold DECIMAL(3,2),  -- è‡ªåŠ¨æ‰¹å‡†çš„ç½®ä¿¡åº¦é˜ˆå€¼

  -- æ‰¹é‡å¤„ç†é…ç½®
  batch_size INTEGER,
  batch_interval_hours INTEGER,

  -- è´¨é‡æ§åˆ¶
  min_confidence_threshold DECIMAL(3,2) DEFAULT 0.5,  -- æœ€ä½ç½®ä¿¡åº¦è¦æ±‚
  require_human_review BOOLEAN DEFAULT TRUE,

  -- åé¦ˆå­¦ä¹ é…ç½®
  enable_feedback_learning BOOLEAN DEFAULT TRUE,
  feedback_weight DECIMAL(3,2) DEFAULT 0.3,  -- åé¦ˆå¯¹ç½®ä¿¡åº¦çš„å½±å“æƒé‡

  -- å†²çªå¤„ç†
  conflict_resolution_strategy VARCHAR(50),  -- 'highest_confidence' | 'manual_select' | 'weighted'

  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  UNIQUE(rule_type)
);
```

---

## 4. ä¸šåŠ¡æµç¨‹è®¾è®¡

### 4.1 è£…é…è§„åˆ™å­¦ä¹ æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ1: æ ·æœ¬ä¸Šä¼ ä¸é¢„å¤„ç†                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç”¨æˆ·ä¸Šä¼ STEPæ–‡ä»¶
    â†“
æ£€æŸ¥å­¦ä¹ é…ç½®(rule_learning_config)
    â†“
è§¦å‘æ–¹å¼åˆ¤æ–­:
â”œâ”€ auto: ç«‹å³å­¦ä¹ 
â”œâ”€ manual: æ˜¾ç¤º"å¼€å§‹å­¦ä¹ "æŒ‰é’®
â””â”€ batch: åŠ å…¥æ‰¹å¤„ç†é˜Ÿåˆ—

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ2: AIå­¦ä¹ ä¸è§„åˆ™æå–                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
è°ƒç”¨è£…é…è§„åˆ™å¤„ç†å™¨
    â†“
STEPæ–‡ä»¶è§£æ (å‡ ä½•ç‰¹å¾æå–)
    â†“
çº¦æŸæ¨ç† (åŸºäºå‡ ä½•å…³ç³»)
    â†“
ç”Ÿæˆå€™é€‰è§„åˆ™ (å¸¦ç½®ä¿¡åº¦)
    â†“
æ’å…¥ rule_base + assembly_rules
status = 'pending'

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ3: äººå·¥å®¡æ ¸ï¼ˆä¸€æœŸï¼šç®€å•å®¡æ ¸ï¼‰                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é€šçŸ¥ç®¡ç†å‘˜: "æœ‰Næ¡å¾…å®¡æ ¸è§„åˆ™"
    â†“
å®¡æ ¸ç•Œé¢æ˜¾ç¤º:
â”œâ”€ è§„åˆ™è¯¦æƒ… (constraint_type, entities, parameters)
â”œâ”€ ç½®ä¿¡åº¦å¾—åˆ†
â”œâ”€ æ¨ç†è·¯å¾„è¯´æ˜
â””â”€ åŸå§‹STEPæ–‡ä»¶é¢„è§ˆ
    â†“
ç®¡ç†å‘˜æ“ä½œ:
â”œâ”€ [æ‰¹å‡†] â†’ review_status = 'approved', is_active = true
â”œâ”€ [æ‹’ç»] â†’ review_status = 'rejected', is_active = false
â””â”€ [ä¿®æ”¹åæ‰¹å‡†] â†’ æ›´æ–°å‚æ•° â†’ approved

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ4: è§„åˆ™åº”ç”¨ä¸åé¦ˆ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
3Dè£…é…ç”Ÿæˆæ—¶
    â†“
æŸ¥è¯¢åŒ¹é…è§„åˆ™:
SELECT * FROM rule_base rb
JOIN assembly_rules ar ON rb.id = ar.rule_id
WHERE rb.is_active = true
  AND rb.review_status = 'approved'
  AND ar.entities åŒ¹é…å½“å‰é›¶ä»¶
ORDER BY rb.confidence_score DESC, ar.priority DESC
    â†“
ç½®ä¿¡åº¦åˆ¤æ–­:
â”œâ”€ confidence >= 0.8 â†’ è‡ªåŠ¨åº”ç”¨
â””â”€ confidence < 0.8 â†’ å¼¹å‡ºé€‰é¡¹è®©ç”¨æˆ·é€‰æ‹©
    â†“
åº”ç”¨åè®°å½•:
INSERT INTO rule_applications (
  rule_id, context, applied_method, result_status
)
    â†“
ç”¨æˆ·åé¦ˆ:
â”œâ”€ [æ­£ç¡®] â†’ success_count++, confidenceå¾®è°ƒ+
â”œâ”€ [é”™è¯¯] â†’ è®©ç”¨æˆ·é€‰æ­£ç¡®ç­”æ¡ˆ â†’ è®°å½•user_correction
â””â”€ [ä¿®æ­£] â†’ æ›´æ–°è§„åˆ™å‚æ•°, é‡æ–°è®­ç»ƒ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ5: åé¦ˆå­¦ä¹ é—­ç¯                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
å®šæ—¶ä»»åŠ¡ (æ¯æ—¥/æ¯å‘¨):
    â†“
åˆ†æ rule_applications æ•°æ®
    â†“
è®¡ç®—æˆåŠŸç‡: success_count / usage_count
    â†“
è°ƒæ•´ç½®ä¿¡åº¦:
new_confidence = original_confidence * 0.7 + success_rate * 0.3
    â†“
æ›´æ–° rule_base.confidence_score
    â†“
ä½æˆåŠŸç‡è§„åˆ™ â†’ æ ‡è®°å¤å®¡ / è‡ªåŠ¨ç¦ç”¨
```

### 4.2 PIDè§„åˆ™å­¦ä¹ æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ1: å›¾çº¸è¯†åˆ«                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç”¨æˆ·ä¸Šä¼ P&IDå›¾çº¸
    â†“
OCRè¯†åˆ« + ç¬¦å·æ£€æµ‹ (å·²æœ‰æœåŠ¡)
    â†“
ç”Ÿæˆè¯†åˆ«ç»“æœ (pid_recognition_resultsè¡¨)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ2: è§„åˆ™æå–ï¼ˆå¯é…ç½®è§¦å‘ï¼‰                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ£€æŸ¥ rule_learning_config.trigger_mode:
â”œâ”€ auto: OCRå®Œæˆåè‡ªåŠ¨è§¦å‘
â””â”€ manual: æ˜¾ç¤º"æå–è§„åˆ™"æŒ‰é’®
    â†“
è°ƒç”¨PIDè§„åˆ™å¤„ç†å™¨
    â†“
åˆ†æè¯†åˆ«ç»“æœ:
â”œâ”€ ç¬¦å·ç±»å‹ç»Ÿè®¡
â”œâ”€ è¿æ¥å…³ç³»åˆ†æ
â”œâ”€ è§„æ ¼å‚æ•°æå–
â””â”€ å¸ƒå±€æ¨¡å¼å­¦ä¹ 
    â†“
ç”Ÿæˆå€™é€‰è§„åˆ™ â†’ rule_base + pid_rules

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ3-5: åŒè£…é…è§„åˆ™æµç¨‹                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
å®¡æ ¸ â†’ åº”ç”¨ â†’ åé¦ˆ â†’ å­¦ä¹ 
```

### 4.3 å»ºç­‘è§„èŒƒå­¦ä¹ æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆA: å®æ—¶æå–                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ä¸Šä¼ PDF/Word â†’ LLMæå– â†’ ç”Ÿæˆå€™é€‰è§„åˆ™ â†’ å®¡æ ¸

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆB: å®šæ—¶æ‰¹å¤„ç†ï¼ˆæ¨èï¼‰                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ä¸Šä¼ PDF/Word
    â†“
å…ˆå…¥çŸ¥è¯†åº“ (knowledge_documentsè¡¨)
    â†“
å®šæ—¶ä»»åŠ¡æ‰«æ:
SELECT * FROM knowledge_documents
WHERE category = 'standard'
  AND processed_for_rules = false
    â†“
æ‰¹é‡è°ƒç”¨LLMæå–è§„åˆ™
    â†“
è§£æGBç¼–å·ã€æ¡æ–‡ã€å‚æ•°
    â†“
ç”Ÿæˆ rule_base + building_rules
    â†“
æ ‡è®° processed_for_rules = true
```

---

## 5. å…³é”®æŠ€æœ¯å®ç°

### 5.1 è§„åˆ™åŒ¹é…å¼•æ“

```javascript
// apps/api/src/services/rules/RuleMatchingEngine.js

class RuleMatchingEngine {
  /**
   * åŒ¹é…é€‚ç”¨è§„åˆ™ï¼ˆé€šç”¨æ¥å£ï¼‰
   */
  async matchRules({ ruleType, context, options = {} }) {
    const {
      minConfidence = 0.5,
      maxResults = 10,
      includeInactive = false
    } = options;

    // æŸ¥è¯¢åŸºç¡€è§„åˆ™
    const query = knex('rule_base')
      .where('rule_type', ruleType)
      .where('review_status', 'approved');

    if (!includeInactive) {
      query.where('is_active', true);
    }

    if (minConfidence) {
      query.where('confidence_score', '>=', minConfidence);
    }

    // JOINä¸šåŠ¡è¡¨
    const businessTable = this.getBusinessTable(ruleType);
    query.join(businessTable, 'rule_base.id', `${businessTable}.rule_id`);

    // ä¸šåŠ¡é€»è¾‘è¿‡æ»¤ï¼ˆå¯æ’æ‹”ï¼‰
    const processor = this.getProcessor(ruleType);
    const filtered = await processor.filterByContext(query, context);

    // æ’åº: ç½®ä¿¡åº¦ Ã— æˆåŠŸç‡ Ã— ä¼˜å…ˆçº§
    const scored = filtered.map(rule => ({
      ...rule,
      matchScore: this.calculateMatchScore(rule, context)
    }));

    scored.sort((a, b) => b.matchScore - a.matchScore);

    return scored.slice(0, maxResults);
  }

  /**
   * è®¡ç®—åŒ¹é…åˆ†æ•°
   */
  calculateMatchScore(rule, context) {
    const successRate = rule.usage_count > 0
      ? rule.success_count / rule.usage_count
      : 0.5; // æ–°è§„åˆ™é»˜è®¤0.5

    // åŠ æƒè®¡ç®—
    return (
      rule.confidence_score * 0.4 +  // åˆå§‹ç½®ä¿¡åº¦
      successRate * 0.4 +             // å†å²æˆåŠŸç‡
      (rule.priority || 5) / 10 * 0.2 // ä¼˜å…ˆçº§
    );
  }

  /**
   * è·å–ä¸šåŠ¡å¤„ç†å™¨ï¼ˆå¯æ’æ‹”ï¼‰
   */
  getProcessor(ruleType) {
    const processors = {
      'assembly': new AssemblyRuleProcessor(),
      'pid': new PIDRuleProcessor(),
      'building': new BuildingRuleProcessor()
    };
    return processors[ruleType];
  }
}
```

### 5.2 åé¦ˆå­¦ä¹ æœåŠ¡

```javascript
// apps/api/src/services/rules/FeedbackLearningService.js

class FeedbackLearningService {
  /**
   * è®°å½•è§„åˆ™åº”ç”¨
   */
  async recordApplication({
    ruleId,
    applicationType,
    context,
    appliedMethod,
    resultStatus,
    userFeedback,
    userCorrection
  }) {
    // æ’å…¥åº”ç”¨è®°å½•
    const [application] = await knex('rule_applications')
      .insert({
        rule_id: ruleId,
        application_type: applicationType,
        context: JSON.stringify(context),
        applied_method: appliedMethod,
        result_status: resultStatus,
        user_feedback: userFeedback,
        user_correction: userCorrection ? JSON.stringify(userCorrection) : null,
        applied_by: req.user.userId,
        applied_at: knex.fn.now()
      })
      .returning('*');

    // æ›´æ–°è§„åˆ™ç»Ÿè®¡
    await knex('rule_base')
      .where('id', ruleId)
      .increment('usage_count', 1)
      .update({
        last_applied_at: knex.fn.now()
      });

    if (resultStatus === 'success' || userFeedback === 'correct') {
      await knex('rule_base')
        .where('id', ruleId)
        .increment('success_count', 1);
    }

    // å³æ—¶è°ƒæ•´ç½®ä¿¡åº¦ï¼ˆå¦‚æœé…ç½®å¯ç”¨ï¼‰
    const config = await this.getLearningConfig(ruleType);
    if (config.enable_feedback_learning) {
      await this.adjustConfidence(ruleId, userFeedback, config.feedback_weight);
    }

    return application;
  }

  /**
   * è°ƒæ•´è§„åˆ™ç½®ä¿¡åº¦
   */
  async adjustConfidence(ruleId, feedback, weight = 0.3) {
    const rule = await knex('rule_base').where('id', ruleId).first();

    const feedbackScore = {
      'correct': 1.0,
      'partially_correct': 0.7,
      'incorrect': 0.3
    }[feedback] || 0.5;

    const newConfidence =
      rule.confidence_score * (1 - weight) +
      feedbackScore * weight;

    await knex('rule_base')
      .where('id', ruleId)
      .update({
        confidence_score: Math.max(0, Math.min(1, newConfidence)),
        updated_at: knex.fn.now()
      });
  }

  /**
   * å®šæœŸæ‰¹é‡å­¦ä¹ ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
   */
  async batchLearning(ruleType) {
    // è·å–æœ€è¿‘30å¤©çš„åº”ç”¨è®°å½•
    const recentApplications = await knex('rule_applications')
      .join('rule_base', 'rule_applications.rule_id', 'rule_base.id')
      .where('rule_base.rule_type', ruleType)
      .where('rule_applications.applied_at', '>', knex.raw("NOW() - INTERVAL '30 days'"))
      .select('rule_id', 'result_status', 'user_feedback');

    // æŒ‰è§„åˆ™åˆ†ç»„ç»Ÿè®¡
    const stats = {};
    recentApplications.forEach(app => {
      if (!stats[app.rule_id]) {
        stats[app.rule_id] = { total: 0, success: 0 };
      }
      stats[app.rule_id].total++;
      if (app.result_status === 'success' || app.user_feedback === 'correct') {
        stats[app.rule_id].success++;
      }
    });

    // æ›´æ–°ç½®ä¿¡åº¦
    for (const [ruleId, stat] of Object.entries(stats)) {
      if (stat.total >= 5) {  // è‡³å°‘5æ¬¡åº”ç”¨æ‰è°ƒæ•´
        const successRate = stat.success / stat.total;
        const rule = await knex('rule_base').where('id', ruleId).first();

        const newConfidence = rule.confidence_score * 0.6 + successRate * 0.4;

        await knex('rule_base')
          .where('id', ruleId)
          .update({ confidence_score: newConfidence });

        // ä½æˆåŠŸç‡é¢„è­¦
        if (successRate < 0.3 && stat.total >= 10) {
          await this.flagForReview(ruleId, 'æˆåŠŸç‡è¿‡ä½ï¼Œå»ºè®®å¤å®¡');
        }
      }
    }
  }
}
```

### 5.3 ä¸šåŠ¡å¤„ç†å™¨æ¥å£ï¼ˆå¯æ’æ‹”ï¼‰

```javascript
// apps/api/src/services/rules/processors/BaseRuleProcessor.js

class BaseRuleProcessor {
  /**
   * ä»æºæ–‡ä»¶å­¦ä¹ è§„åˆ™ï¼ˆå­ç±»å®ç°ï¼‰
   */
  async learnFromSource(sourceFile, config) {
    throw new Error('Must implement learnFromSource');
  }

  /**
   * æ ¹æ®ä¸Šä¸‹æ–‡è¿‡æ»¤è§„åˆ™ï¼ˆå­ç±»å®ç°ï¼‰
   */
  async filterByContext(query, context) {
    throw new Error('Must implement filterByContext');
  }

  /**
   * åº”ç”¨è§„åˆ™åˆ°è®¾è®¡ï¼ˆå­ç±»å®ç°ï¼‰
   */
  async applyRule(rule, design) {
    throw new Error('Must implement applyRule');
  }
}

// apps/api/src/services/rules/processors/AssemblyRuleProcessor.js
class AssemblyRuleProcessor extends BaseRuleProcessor {
  async learnFromSource(stepFile, config) {
    // 1. è§£æSTEPæ–‡ä»¶
    const parts = await this.parseSTEP(stepFile);

    // 2. æå–å‡ ä½•ç‰¹å¾
    const features = await this.extractGeometricFeatures(parts);

    // 3. æ¨ç†çº¦æŸå…³ç³»
    const constraints = await this.inferConstraints(features);

    // 4. ç”Ÿæˆè§„åˆ™
    const rules = constraints.map(c => ({
      constraint_type: c.type,
      entities: c.entities,
      parameters: c.parameters,
      confidence: c.confidence,
      reasoning_path: c.reasoning
    }));

    return rules;
  }

  async filterByContext(query, context) {
    // context = { partA: {}, partB: {} }
    // æ ¹æ®é›¶ä»¶ç‰¹å¾è¿‡æ»¤é€‚ç”¨è§„åˆ™
    return query.where(knex.raw(
      "entities @> ?",
      [JSON.stringify([{ part: context.partA.name }])]
    ));
  }
}
```

---

## 6. å‰ç«¯ç•Œé¢è®¾è®¡

### 6.1 ç»Ÿä¸€è§„åˆ™ç®¡ç†é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§„åˆ™ç®¡ç†ä¸­å¿ƒ                                    [é…ç½®] [å¸®åŠ©] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [è£…é…è§„åˆ™] [PIDè§„åˆ™] [å»ºç­‘è§„èŒƒ] [å·¥è‰ºè§„åˆ™]                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  çŠ¶æ€ç­›é€‰: [â—‹å…¨éƒ¨] [â—‹å¾…å®¡æ ¸] [â—‹å·²æ‰¹å‡†] [â—‹å·²æ‹’ç»]             â”‚
â”‚  ç½®ä¿¡åº¦: [â”â”â—â”â”â”â”] 0.5-1.0                                   â”‚
â”‚  æ¥æº: [å…¨éƒ¨ â–¼]  æœç´¢: [___________________] [ğŸ”]           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è§„åˆ™ID  â”‚ åç§°        â”‚ ç±»å‹    â”‚ ç½®ä¿¡åº¦ â”‚ çŠ¶æ€   â”‚ æ“ä½œ    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  ASM001  â”‚ æ³•å…°åŒè½´çº¦æŸ â”‚ è£…é…    â”‚ 0.92   â”‚ å¾…å®¡æ ¸ â”‚ [å®¡æ ¸]  â”‚
â”‚  PID023  â”‚ é˜€é—¨è¿æ¥è§„åˆ™ â”‚ PID     â”‚ 0.87   â”‚ å·²æ‰¹å‡† â”‚ [è¯¦æƒ…]  â”‚
â”‚  GB5080  â”‚ æœºæˆ¿é«˜åº¦è¦æ±‚ â”‚ å»ºç­‘    â”‚ 0.95   â”‚ å·²æ‰¹å‡† â”‚ [è¯¦æƒ…]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 è§„åˆ™å®¡æ ¸ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§„åˆ™å®¡æ ¸ - ASM001                               [å…³é—­] [æ‰¹å‡†]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŸºæœ¬ä¿¡æ¯                                                     â”‚
â”‚  â”œâ”€ è§„åˆ™ç±»å‹: è£…é…è§„åˆ™ - åŒè½´çº¦æŸ                             â”‚
â”‚  â”œâ”€ æ¥æºæ–‡ä»¶: part_assembly_001.STEP                         â”‚
â”‚  â”œâ”€ æå–æ–¹å¼: AIå­¦ä¹                                          â”‚
â”‚  â””â”€ ç½®ä¿¡åº¦: 0.92                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è§„åˆ™è¯¦æƒ…                                                     â”‚
â”‚  â”œâ”€ çº¦æŸç±»å‹: mate (é…åˆ)                                     â”‚
â”‚  â”œâ”€ å®ä½“1: é›¶ä»¶A - åœ†æŸ±é¢                                     â”‚
â”‚  â”œâ”€ å®ä½“2: é›¶ä»¶B - åœ†æŸ±å­”                                     â”‚
â”‚  â””â”€ å‚æ•°: { tolerance: 0.05mm }                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¨ç†è·¯å¾„                                                     â”‚
â”‚  1. æ£€æµ‹åˆ°é›¶ä»¶Aæœ‰å¤–åœ†æŸ±ç‰¹å¾ (ç›´å¾„50mm)                         â”‚
â”‚  2. æ£€æµ‹åˆ°é›¶ä»¶Bæœ‰å†…åœ†æŸ±ç‰¹å¾ (ç›´å¾„50.05mm)                      â”‚
â”‚  3. ç›´å¾„åŒ¹é… + å…¬å·®åˆç† â†’ æ¨æ–­ä¸ºé…åˆçº¦æŸ                       â”‚
â”‚  4. å‚è€ƒæ ·æœ¬: 10ä¸ªç±»ä¼¼æ¡ˆä¾‹ï¼Œç½®ä¿¡åº¦0.92                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3Dé¢„è§ˆ                                                       â”‚
â”‚  [            é›¶ä»¶Aä¸é›¶ä»¶Bçš„è£…é…ç¤ºæ„å›¾            ]            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®¡æ ¸æ„è§                                                     â”‚
â”‚  [________________________________________]                   â”‚
â”‚                                                               â”‚
â”‚  [æ‹’ç»]  [ä¿®æ”¹å‚æ•°]  [æ‰¹å‡†å¹¶æ¿€æ´»]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 è§„åˆ™å­¦ä¹ é…ç½®é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§„åˆ™å­¦ä¹ é…ç½®                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è£…é…è§„åˆ™å­¦ä¹                                                  â”‚
â”‚  â”œâ”€ è§¦å‘æ–¹å¼: [â—‹ç«‹å³è‡ªåŠ¨ â—æ‰‹åŠ¨è§¦å‘ â—‹æ‰¹é‡å¤„ç†]                 â”‚
â”‚  â”œâ”€ è‡ªåŠ¨æ‰¹å‡†é˜ˆå€¼: [â”â”â”â”â—â”â”] 0.9 (ç½®ä¿¡åº¦â‰¥0.9è‡ªåŠ¨æ‰¹å‡†)         â”‚
â”‚  â”œâ”€ æ‰¹é‡å¤§å°: [10] ä¸ªæ–‡ä»¶                                     â”‚
â”‚  â””â”€ åé¦ˆå­¦ä¹ : [âœ“] å¯ç”¨  æƒé‡: [â”â—â”â”â”â”] 0.3                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PIDè§„åˆ™å­¦ä¹                                                   â”‚
â”‚  â”œâ”€ è§¦å‘æ–¹å¼: [â—OCRåè‡ªåŠ¨ â—‹æ‰‹åŠ¨è§¦å‘]                         â”‚
â”‚  â”œâ”€ æœ€ä½ç½®ä¿¡åº¦: [â”â”â—â”â”â”â”] 0.5                                â”‚
â”‚  â””â”€ éœ€è¦äººå·¥å®¡æ ¸: [âœ“]                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å»ºç­‘è§„èŒƒå­¦ä¹                                                  â”‚
â”‚  â”œâ”€ æå–æ–¹å¼: [â—‹å®æ—¶æå– â—å®šæ—¶ä»»åŠ¡]                          â”‚
â”‚  â”œâ”€ å®šæ—¶é—´éš”: [24] å°æ—¶                                       â”‚
â”‚  â””â”€ LLMæ¨¡å‹: [GPT-4 â–¼]                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. APIæ¥å£è®¾è®¡

### 7.1 è§„åˆ™å­¦ä¹ æ¥å£

```javascript
// POST /api/rules/learn
{
  "ruleType": "assembly",
  "sourceType": "step_file",
  "sourceFileId": "uuid",
  "config": {
    "triggerMode": "manual",
    "autoApprove": false
  }
}

// Response
{
  "success": true,
  "data": {
    "taskId": "learn_task_123",
    "extractedRules": [
      {
        "id": "rule_uuid",
        "name": "æ³•å…°åŒè½´çº¦æŸ",
        "confidence": 0.92,
        "status": "pending_review"
      }
    ]
  }
}
```

### 7.2 è§„åˆ™å®¡æ ¸æ¥å£

```javascript
// POST /api/rules/:ruleId/review
{
  "action": "approve",  // 'approve' | 'reject' | 'modify'
  "comment": "å®¡æ ¸æ„è§",
  "modifications": {
    "parameters": { ... }  // å¦‚æœæ˜¯modify
  }
}
```

### 7.3 è§„åˆ™åŒ¹é…æ¥å£

```javascript
// POST /api/rules/match
{
  "ruleType": "assembly",
  "context": {
    "partA": { "name": "Flange", "features": [...] },
    "partB": { "name": "Pipe", "features": [...] }
  },
  "options": {
    "minConfidence": 0.7,
    "maxResults": 5
  }
}

// Response
{
  "success": true,
  "data": {
    "matches": [
      {
        "rule": { ... },
        "matchScore": 0.89,
        "autoApply": true  // confidence >= 0.8
      }
    ]
  }
}
```

### 7.4 åé¦ˆæ¥å£

```javascript
// POST /api/rules/feedback
{
  "ruleId": "uuid",
  "applicationType": "assembly_generation",
  "context": { ... },
  "feedback": "correct",  // 'correct' | 'incorrect' | 'partially_correct'
  "correction": { ... }  // å¦‚æœæ˜¯incorrect
}
```

---

## 8. å®æ–½è®¡åˆ’

### 8.1 ä¸€æœŸï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

**Week 1-2: æ•°æ®å±‚**
- [ ] åˆ›å»º rule_base åŠä¸‰ä¸ªä¸šåŠ¡è¡¨
- [ ] åˆ›å»º rule_applications è¡¨
- [ ] åˆ›å»º rule_learning_config è¡¨
- [ ] æ•°æ®è¿ç§»è„šæœ¬ï¼ˆæ•´åˆç°æœ‰ assembly_rules ç­‰ï¼‰

**Week 3-4: åç«¯æ ¸å¿ƒæœåŠ¡**
- [ ] RuleMatchingEngineï¼ˆè§„åˆ™åŒ¹é…å¼•æ“ï¼‰
- [ ] FeedbackLearningServiceï¼ˆåé¦ˆå­¦ä¹ æœåŠ¡ï¼‰
- [ ] BaseRuleProcessor æŠ½è±¡ç±»
- [ ] AssemblyRuleProcessorï¼ˆè£…é…è§„åˆ™å¤„ç†å™¨ï¼‰

**Week 5-6: APIä¸å‰ç«¯**
- [ ] è§„åˆ™ç®¡ç†APIï¼ˆCRUD + å®¡æ ¸ï¼‰
- [ ] è§„åˆ™å­¦ä¹ API
- [ ] ç»Ÿä¸€è§„åˆ™ç®¡ç†é¡µé¢
- [ ] è§„åˆ™å®¡æ ¸ç•Œé¢

**Week 7: é›†æˆä¸æµ‹è¯•**
- [ ] è£…é…ç”Ÿæˆæµç¨‹é›†æˆè§„åˆ™å¼•æ“
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–

### 8.2 äºŒæœŸï¼ˆæ‰©å±•åŠŸèƒ½ï¼‰

**PIDè§„åˆ™å­¦ä¹ **
- [ ] PIDRuleProcessor å®ç°
- [ ] OCRç»“æœ â†’ è§„åˆ™æå–æµç¨‹
- [ ] PIDè®¾è®¡å·¥å…·é›†æˆ

**å»ºç­‘è§„èŒƒå­¦ä¹ **
- [ ] BuildingRuleProcessor å®ç°
- [ ] LLMæå–æµç¨‹
- [ ] åˆè§„æ£€æŸ¥å·¥å…·

**é«˜çº§å®¡æ ¸**
- [ ] åˆ†çº§å®¡æ ¸å·¥ä½œæµ
- [ ] å¤šäººåä½œå®¡æ ¸
- [ ] æŠ•ç¥¨æœºåˆ¶

---

## 9. æŠ€æœ¯é£é™©ä¸å¯¹ç­–

### 9.1 AIå­¦ä¹ å‡†ç¡®æ€§
**é£é™©**: è§„åˆ™æå–ç½®ä¿¡åº¦ä¸å¤Ÿé«˜
**å¯¹ç­–**:
- äººå·¥å®¡æ ¸å¡ç‚¹
- åˆæœŸè®¾ç½®é«˜é˜ˆå€¼ï¼ˆ0.8+ï¼‰
- ç§¯ç´¯åé¦ˆæ•°æ®æŒç»­ä¼˜åŒ–

### 9.2 è§„åˆ™å†²çª
**é£é™©**: å¤šæ¡è§„åˆ™åŒæ—¶é€‚ç”¨ä¸”äº’ç›¸å†²çª
**å¯¹ç­–**:
- conflicts_with å­—æ®µè®°å½•å†²çªå…³ç³»
- åŒ¹é…æ—¶æ£€æµ‹å†²çªï¼Œé™çº§ä¸ºäººå·¥é€‰æ‹©
- äºŒæœŸå®ç°è§„åˆ™ä¼˜å…ˆçº§é“¾

### 9.3 æ€§èƒ½é—®é¢˜
**é£é™©**: è§„åˆ™åº“å¢å¤§åæŸ¥è¯¢å˜æ…¢
**å¯¹ç­–**:
- ç´¢å¼•ä¼˜åŒ–ï¼ˆrule_type, confidence, review_statusï¼‰
- JSONBå­—æ®µGINç´¢å¼•
- Redisç¼“å­˜é«˜é¢‘è§„åˆ™
- å®šæœŸå½’æ¡£ä½ä½¿ç”¨ç‡è§„åˆ™

### 9.4 æ•°æ®ä¸€è‡´æ€§
**é£é™©**: rule_base ä¸ä¸šåŠ¡è¡¨æ•°æ®ä¸åŒæ­¥
**å¯¹ç­–**:
- å¤–é”®çº§è”åˆ é™¤
- äº‹åŠ¡ä¿è¯åŸå­æ€§
- å®šæœŸä¸€è‡´æ€§æ£€æŸ¥ä»»åŠ¡

---

## 10. æˆåŠŸæŒ‡æ ‡

### 10.1 ç³»ç»ŸæŒ‡æ ‡
- è§„åˆ™å­¦ä¹ æˆåŠŸç‡ > 80%
- è§„åˆ™åŒ¹é…å“åº”æ—¶é—´ < 500ms
- å®¡æ ¸å‘¨æœŸ < 2å¤©

### 10.2 ä¸šåŠ¡æŒ‡æ ‡
- è£…é…è‡ªåŠ¨åŒ–ç‡ä»30% â†’ 70%
- PIDè®¾è®¡æ•ˆç‡æå‡50%
- åˆè§„æ£€æŸ¥è¦†ç›–ç‡100%

### 10.3 è´¨é‡æŒ‡æ ‡
- è§„åˆ™åº”ç”¨æˆåŠŸç‡ > 85%
- äººå·¥å¹²é¢„ç‡ < 30%
- ç”¨æˆ·æ»¡æ„åº¦ > 4.0/5.0

---

## 11. åç»­æ¼”è¿›æ–¹å‘

### 11.1 ä¸‰æœŸï¼šæ™ºèƒ½åŒ–
- è§„åˆ™è‡ªåŠ¨å‘ç°ï¼ˆæ— ç›‘ç£å­¦ä¹ ï¼‰
- è§„åˆ™æ¨èç³»ç»Ÿ
- è·¨é¢†åŸŸè§„åˆ™è¿ç§»

### 11.2 å››æœŸï¼šç”Ÿæ€åŒ–
- è§„åˆ™å¸‚åœºï¼ˆå…±äº«/äº¤æ˜“ï¼‰
- è¡Œä¸šè§„åˆ™åŒ…
- æ’ä»¶åŒ–è§„åˆ™å¼•æ“

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-06
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
