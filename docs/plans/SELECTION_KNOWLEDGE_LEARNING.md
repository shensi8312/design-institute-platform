# é›¶ä»¶é€‰å‹çŸ¥è¯†å­¦ä¹  - å®Œæ•´æ–¹æ¡ˆ

## ğŸ¯ æ‚¨çš„æ ¸å¿ƒé—®é¢˜

**æ‚¨æƒ³è¦ç³»ç»Ÿå­¦ä¼šï¼š**
1. â“ **ä¸ºä»€ä¹ˆé€‰è¿™ä¸ªå‹å·** - ä¸ºä»€ä¹ˆé€‰DN50è€Œä¸æ˜¯DN80ï¼Ÿ
2. â“ **ä¸ºä»€ä¹ˆè¿™æ ·ç»„è£…** - ä¸ºä»€ä¹ˆé˜€é—¨+æ³•å…°ç”¨4ä¸ªM8èºæ “ï¼Ÿ
3. â“ **ä¸ºä»€ä¹ˆè¿™æ ·åŒ¹é…** - ä¸ºä»€ä¹ˆDN50é˜€é—¨é…DN50æ³•å…°ï¼Ÿ
4. â“ **ä¸‹æ¬¡èƒ½è‡ªåŠ¨é€‰å‹å—** - ç»™æ–°çš„PIDå›¾ï¼Œèƒ½å¦è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„é›¶ä»¶ï¼Ÿ

**ç®€å•è¯´ï¼šä»PIDåŠŸèƒ½éœ€æ±‚ â†’ è‡ªåŠ¨é€‰å‹ â†’ è‡ªåŠ¨è£…é…**

---

## ğŸ“Š ç°æœ‰ç³»ç»Ÿèƒ½åŠ›åˆ†æ

### âœ… ç°æœ‰ç³»ç»Ÿ**èƒ½å­¦åˆ°**çš„

| çŸ¥è¯†ç±»å‹ | ç¤ºä¾‹ | ç°çŠ¶ |
|---------|------|-----|
| è£…é…è§„åˆ™ | "é˜€é—¨+æ³•å…° â†’ èºæ “è¿æ¥" | âœ… å¯ä»¥å­¦ |
| å‡ ä½•çº¦æŸ | "è·ç¦»5mm, 4ä¸ªèºæ “" | âœ… å¯ä»¥å­¦ |
| é›¶ä»¶ç±»å‹ç»„åˆ | "é˜€é—¨å¿…é¡»é…æ³•å…°" | âœ… å¯ä»¥å­¦ |
| æè´¨åŒ¹é… | "ä¸é”ˆé’¢é˜€é—¨é…ä¸é”ˆé’¢æ³•å…°" | âœ… å¯ä»¥å­¦ï¼ˆå¦‚æœBOMæœ‰æè´¨ä¿¡æ¯ï¼‰ |

**å½“å‰å­¦ä¹ è¾“å…¥ï¼š**
```
BOM(é›¶ä»¶æ¸…å•) + è£…é…å›¾STEP
    â†“
å­¦åˆ°ï¼šé›¶ä»¶A + é›¶ä»¶B â†’ å¦‚ä½•è£…é…
```

**èƒ½å›ç­”çš„é—®é¢˜ï¼š**
- âœ… "å·²çŸ¥æœ‰çƒé˜€DN50å’Œæ³•å…°DN50ï¼Œå¦‚ä½•è£…é…ï¼Ÿ"
- âœ… "çƒé˜€å’Œæ³•å…°ç”¨ä»€ä¹ˆçº¦æŸï¼Ÿ"
- âœ… "èºæ “åº”è¯¥æ˜¯ä»€ä¹ˆè§„æ ¼ï¼Ÿ"

### âŒ ç°æœ‰ç³»ç»Ÿ**å­¦ä¸åˆ°**çš„

| çŸ¥è¯†ç±»å‹ | ç¤ºä¾‹ | ç°çŠ¶ |
|---------|------|-----|
| **é€‰å‹è§„åˆ™** | "ç®¡é“DN50 â†’ é€‰DN50é˜€é—¨" | âŒ å­¦ä¸åˆ° |
| **è§„æ ¼æ¨å¯¼** | "å‹åŠ›16bar â†’ é€‰PN16é›¶ä»¶" | âŒ å­¦ä¸åˆ° |
| **åŠŸèƒ½åŒ¹é…** | "æµé‡100mÂ³/h â†’ é€‰50-200/15æ³µ" | âŒ å­¦ä¸åˆ° |
| **é…å¥—é€‰å‹** | "é€‰DN50é˜€é—¨ â†’ å¿…é€‰DN50æ³•å…°" | âŒ å­¦ä¸åˆ° |
| **æè´¨é€‰æ‹©** | "è…èš€æ€§æµä½“ â†’ é€‰ä¸é”ˆé’¢" | âŒ å­¦ä¸åˆ° |

**ç¼ºå¤±çš„å­¦ä¹ è¾“å…¥ï¼š**
```
âŒ æ²¡æœ‰ï¼šPIDå›¾ï¼ˆåŠŸèƒ½éœ€æ±‚ï¼‰
âŒ æ²¡æœ‰ï¼šå·¥å†µå‚æ•°ï¼ˆå‹åŠ›ã€æ¸©åº¦ã€æµé‡ï¼‰
âŒ æ²¡æœ‰ï¼šæµä½“ç‰¹æ€§ï¼ˆè…èš€æ€§ã€ç²˜åº¦ï¼‰
```

**æ— æ³•å›ç­”çš„é—®é¢˜ï¼š**
- âŒ "ç®¡é“æ˜¯DN50ï¼Œåº”è¯¥é€‰ä»€ä¹ˆé˜€é—¨ï¼Ÿ"
- âŒ "å‹åŠ›æ˜¯16barï¼Œåº”è¯¥é€‰ä»€ä¹ˆå‹åŠ›ç­‰çº§ï¼Ÿ"
- âŒ "æµé‡æ˜¯100mÂ³/hï¼Œåº”è¯¥é€‰ä»€ä¹ˆæ³µï¼Ÿ"

---

## ğŸ” ä¸ºä»€ä¹ˆå­¦ä¸åˆ°é€‰å‹çŸ¥è¯†ï¼Ÿ

### æ ¹æœ¬åŸå› ï¼šç¼ºå°‘**åŠŸèƒ½éœ€æ±‚ä¸é›¶ä»¶è§„æ ¼çš„å…³è”**

**å®Œæ•´çš„å­¦ä¹ æ ·æœ¬åº”è¯¥åŒ…å«ï¼š**

```
å­¦ä¹ æ¡ˆä¾‹ = PIDå›¾ + BOM + è£…é…å›¾STEP + (å¯é€‰)é›¶ä»¶å›¾

PIDå›¾å‘Šè¯‰æˆ‘ä»¬ï¼š
â”œâ”€ ç®¡é“å£å¾„ï¼šDN50
â”œâ”€ å·¥ä½œå‹åŠ›ï¼š16 bar
â”œâ”€ æµä½“ç±»å‹ï¼šæ°´/è…èš€æ€§æ¶²ä½“
â”œâ”€ æµé‡ï¼š100 mÂ³/h
â””â”€ è®¾å¤‡è¿æ¥å…³ç³»

BOMå‘Šè¯‰æˆ‘ä»¬ï¼š
â”œâ”€ é€‰æ‹©äº†ï¼šDN50 PN16çƒé˜€
â”œâ”€ é€‰æ‹©äº†ï¼š50-200/15ç¦»å¿ƒæ³µ
â””â”€ é€‰æ‹©äº†ï¼šDN50 PN16æ³•å…°

è£…é…å›¾STEPå‘Šè¯‰æˆ‘ä»¬ï¼š
â””â”€ å¦‚ä½•è£…é…è¿™äº›é›¶ä»¶

å®Œæ•´å­¦ä¹  = PIDåŠŸèƒ½éœ€æ±‚ â†’ é›¶ä»¶é€‰å‹å†³ç­– â†’ è£…é…å…³ç³»
```

**ç°åœ¨åªæœ‰ï¼š**
```
âŒ BOM + STEP
åªèƒ½å­¦åˆ°ï¼šå·²çŸ¥é›¶ä»¶å¦‚ä½•è£…é…
ä¸èƒ½å­¦åˆ°ï¼šå¦‚ä½•é€‰æ‹©é›¶ä»¶
```

---

## ğŸ› ï¸ å®Œæ•´è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­¦ä¹ é˜¶æ®µï¼šå»ºç«‹çŸ¥è¯†åº“                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¾“å…¥ï¼šå®Œæ•´å·¥ç¨‹æ¡ˆä¾‹
â”œâ”€ PIDå›¾ï¼ˆåŠŸèƒ½éœ€æ±‚ï¼‰
â”œâ”€ BOMæ¸…å•ï¼ˆé€‰å‹ç»“æœï¼‰
â”œâ”€ è£…é…å›¾STEPï¼ˆè£…é…æ–¹æ¡ˆï¼‰
â””â”€ è®¾è®¡è¯´æ˜ï¼ˆå¯é€‰ï¼‰

         â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æå–ä¸‰ç±»çŸ¥è¯†                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1ï¸âƒ£ é€‰å‹çŸ¥è¯†ï¼ˆPID â†’ BOMï¼‰                                     â”‚
â”‚     - PIDç®¡é“DN50 â†’ é€‰DN50é˜€é—¨ã€DN50æ³•å…°                       â”‚
â”‚     - PIDå‹åŠ›16bar â†’ é€‰PN16é›¶ä»¶                               â”‚
â”‚     - PIDæµé‡100mÂ³/h â†’ é€‰50-200/15æ³µ                          â”‚
â”‚                                                               â”‚
â”‚  2ï¸âƒ£ é…å¥—çŸ¥è¯†ï¼ˆBOM â†’ BOMï¼‰                                     â”‚
â”‚     - é€‰DN50é˜€é—¨ â†’ å¿…é¡»é€‰DN50æ³•å…°                              â”‚
â”‚     - é€‰PN16é˜€é—¨ â†’ å¿…é¡»é€‰PN16æ³•å…°                              â”‚
â”‚     - é€‰DN50æ³•å…° â†’ éœ€è¦M8èºæ “(4-8ä¸ª)                           â”‚
â”‚                                                               â”‚
â”‚  3ï¸âƒ£ è£…é…çŸ¥è¯†ï¼ˆBOM â†’ STEPï¼‰                                    â”‚
â”‚     - é˜€é—¨+æ³•å…° â†’ SCREWè¿æ¥ï¼Œ4èºæ “ï¼Œé—´è·5mm                     â”‚
â”‚     - æ³µ+åº•åº§ â†’ å›ºå®šï¼Œ4ä¸ªåœ°è„šèºæ “                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â†“

å­˜å‚¨åˆ°çŸ¥è¯†åº“
â”œâ”€ é€‰å‹è§„åˆ™åº“ï¼ˆSelection Rulesï¼‰
â”œâ”€ é…å¥—è§„åˆ™åº“ï¼ˆMatching Rulesï¼‰
â””â”€ è£…é…è§„åˆ™åº“ï¼ˆAssembly Rulesï¼‰


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨é˜¶æ®µï¼šè‡ªåŠ¨è®¾è®¡                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¾“å…¥ï¼šæ–°çš„PIDå›¾

         â†“

1ï¸âƒ£ PIDè¯†åˆ«
   - è¯†åˆ«è®¾å¤‡ç±»å‹ï¼ˆæ³µã€é˜€é—¨ã€ä»ªè¡¨ï¼‰
   - æå–å·¥å†µå‚æ•°ï¼ˆDNã€å‹åŠ›ã€æµé‡ï¼‰
   - æå–æµä½“ç‰¹æ€§

         â†“

2ï¸âƒ£ è‡ªåŠ¨é€‰å‹ï¼ˆä½¿ç”¨é€‰å‹è§„åˆ™åº“ï¼‰
   æŸ¥è¯¢è§„åˆ™ï¼š
   - "PIDç®¡é“DN50" â†’ åŒ¹é…è§„åˆ™ â†’ é€‰"DN50çƒé˜€"
   - "PIDå‹åŠ›16bar" â†’ åŒ¹é…è§„åˆ™ â†’ é€‰"PN16"ç­‰çº§
   - "PIDæµé‡100mÂ³/h" â†’ åŒ¹é…è§„åˆ™ â†’ é€‰"50-200/15æ³µ"

   è¾“å‡ºï¼šåˆæ­¥BOMæ¸…å•

         â†“

3ï¸âƒ£ é…å¥—è¡¥å……ï¼ˆä½¿ç”¨é…å¥—è§„åˆ™åº“ï¼‰
   æŸ¥è¯¢è§„åˆ™ï¼š
   - "å·²é€‰DN50é˜€é—¨" â†’ åŒ¹é…è§„åˆ™ â†’ è¡¥å……"DN50æ³•å…°"
   - "å·²é€‰DN50æ³•å…°" â†’ åŒ¹é…è§„åˆ™ â†’ è¡¥å……"M8èºæ “Ã—4"
   - "å·²é€‰PN16é˜€é—¨" â†’ åŒ¹é…è§„åˆ™ â†’ è¡¥å……"PN16å«ç‰‡"

   è¾“å‡ºï¼šå®Œæ•´BOMæ¸…å•

         â†“

4ï¸âƒ£ è‡ªåŠ¨è£…é…ï¼ˆä½¿ç”¨è£…é…è§„åˆ™åº“ï¼‰
   æŸ¥è¯¢è§„åˆ™ï¼š
   - "é˜€é—¨+æ³•å…°" â†’ åŒ¹é…è§„åˆ™ â†’ ç”ŸæˆSCREWçº¦æŸ(5mm, 4èºæ “)
   - "æ³µ+åº•åº§" â†’ åŒ¹é…è§„åˆ™ â†’ ç”Ÿæˆå›ºå®šçº¦æŸ

   è¾“å‡ºï¼šè£…é…å›¾STEP

         â†“

äººå·¥å®¡æ ¸ â†’ å¯¼å‡ºäº¤ä»˜ç‰©
```

---

## ğŸ’¡ å…³é”®æŠ€æœ¯ï¼šå¦‚ä½•æå–é€‰å‹çŸ¥è¯†

### æŠ€æœ¯1ï¼šPIDå‚æ•°ä¸BOMè§„æ ¼å…³è”

**å­¦ä¹ è¾“å…¥ï¼š**
```
PIDå›¾ï¼š
  - ç®¡é“æ ‡æ³¨ï¼šDN50, 16bar
  - æµä½“ï¼šæ°´
  - æµé‡ï¼š100 mÂ³/h

BOMæ¸…å•ï¼š
  - V-001: çƒé˜€, DN50, PN16, ä¸é”ˆé’¢
  - F-001: æ³•å…°, DN50, PN16, ç¢³é’¢
  - P-001: ç¦»å¿ƒæ³µ, 50-200/15, 11kW
```

**å…³è”åˆ†æï¼š**
```python
# æå–å…³è”è§„åˆ™
def extract_selection_rules(pid_data, bom_data):
    rules = []

    # è§„åˆ™1: ç®¡é“å£å¾„ â†’ é˜€é—¨å£å¾„
    pid_dn = extract_dn_from_pid(pid_data)  # DN50
    valve = find_valve_in_bom(bom_data)
    valve_dn = extract_dn_from_spec(valve.specification)  # DN50

    if pid_dn == valve_dn:
        rules.append({
            'rule_type': 'selection',
            'condition': {
                'pid_pipe_dn': pid_dn
            },
            'action': {
                'select_part_type': 'çƒé˜€',
                'specification': f'DN{pid_dn}'
            },
            'confidence': 0.9,
            'reasoning': 'ç®¡é“å£å¾„ä¸é˜€é—¨å£å¾„åŒ¹é…'
        })

    # è§„åˆ™2: å‹åŠ›ç­‰çº§ â†’ é›¶ä»¶å‹åŠ›ç­‰çº§
    pid_pressure = extract_pressure_from_pid(pid_data)  # 16 bar
    pn_level = pressure_to_pn(pid_pressure)  # PN16

    for part in bom_data:
        if f'PN{pn_level}' in part.specification:
            rules.append({
                'rule_type': 'selection',
                'condition': {
                    'pid_pressure_bar': pid_pressure
                },
                'action': {
                    'select_pn_level': f'PN{pn_level}'
                },
                'confidence': 0.95,
                'reasoning': 'å‹åŠ›16barå¯¹åº”PN16ç­‰çº§'
            })

    # è§„åˆ™3: æµé‡ â†’ æ³µå‹å·
    pid_flow = extract_flow_from_pid(pid_data)  # 100 mÂ³/h
    pump = find_pump_in_bom(bom_data)
    pump_model = pump.specification  # 50-200/15

    rules.append({
        'rule_type': 'selection',
        'condition': {
            'pid_flow_m3_h': pid_flow,
            'fluid_type': 'æ°´'
        },
        'action': {
            'select_part': 'ç¦»å¿ƒæ³µ',
            'model': pump_model
        },
        'confidence': 0.85,
        'reasoning': f'æµé‡{pid_flow}mÂ³/hé€‚ç”¨æ³µå‹å·{pump_model}'
    })

    return rules
```

**å­¦ä¹ ç»“æœç¤ºä¾‹ï¼š**
```json
{
  "rule_id": "SELECT_VALVE_BY_DN",
  "rule_name": "æ ¹æ®ç®¡é“å£å¾„é€‰æ‹©é˜€é—¨",
  "condition": {
    "pid_pipe_dn": 50
  },
  "action": {
    "part_type": "çƒé˜€",
    "specification": "DN50"
  },
  "confidence": 0.95,
  "sample_count": 15
}
```

### æŠ€æœ¯2ï¼šé…å¥—è§„åˆ™å­¦ä¹ 

**å­¦ä¹ è¾“å…¥ï¼š**
```
BOMæ¸…å•ä¸­çš„å…±ç°æ¨¡å¼ï¼š
  - çƒé˜€DN50 PN16  â†â†’  æ³•å…°DN50 PN16 (å‡ºç°15æ¬¡)
  - æ³•å…°DN50      â†â†’  M8èºæ “Ã—4      (å‡ºç°15æ¬¡)
  - ä¸é”ˆé’¢é˜€é—¨     â†â†’  ä¸é”ˆé’¢æ³•å…°     (å‡ºç°12æ¬¡)
```

**é…å¥—è§„åˆ™æå–ï¼š**
```python
def extract_matching_rules(bom_samples):
    # ç»Ÿè®¡é›¶ä»¶å…±ç°é¢‘ç‡
    co_occurrence = {}

    for bom in bom_samples:
        for i, part_a in enumerate(bom):
            for part_b in bom[i+1:]:
                # æ£€æŸ¥è§„æ ¼åŒ¹é…
                if has_common_spec(part_a, part_b):
                    key = (part_a.type, part_b.type, get_common_spec(part_a, part_b))
                    co_occurrence[key] = co_occurrence.get(key, 0) + 1

    # ç”Ÿæˆé…å¥—è§„åˆ™
    rules = []
    for (type_a, type_b, spec), count in co_occurrence.items():
        if count >= 3:  # è‡³å°‘å‡ºç°3æ¬¡
            rules.append({
                'rule_type': 'matching',
                'condition': {
                    'selected_part_type': type_a,
                    'selected_spec': spec
                },
                'action': {
                    'must_select_part_type': type_b,
                    'matching_spec': spec
                },
                'confidence': count / len(bom_samples),
                'sample_count': count
            })

    return rules
```

**å­¦ä¹ ç»“æœç¤ºä¾‹ï¼š**
```json
{
  "rule_id": "MATCH_VALVE_FLANGE_DN",
  "rule_name": "é˜€é—¨æ³•å…°å£å¾„é…å¥—è§„åˆ™",
  "condition": {
    "selected_part_type": "çƒé˜€",
    "selected_dn": 50
  },
  "action": {
    "must_select_part": "æ³•å…°",
    "matching_dn": 50
  },
  "confidence": 0.95,
  "reasoning": "é˜€é—¨DN50å¿…é¡»é…DN50æ³•å…°"
}
```

---

## ğŸš€ å®æ–½æ–¹æ¡ˆ

### Phase 1: å¢å¼ºå­¦ä¹ èƒ½åŠ›ï¼ˆ2å‘¨ï¼‰

**ç›®æ ‡ï¼šè®©ç³»ç»Ÿèƒ½å¤Ÿå­¦ä¹ é€‰å‹å’Œé…å¥—çŸ¥è¯†**

#### 1.1 æ‰©å±•å­¦ä¹ è¾“å…¥
```python
# æ–°å¢ï¼šå®Œæ•´æ¡ˆä¾‹å­¦ä¹ API
POST /api/assembly/learn-complete-case

Request:
{
  "case_name": "åŒ–å·¥ç®¡é“ç³»ç»Ÿ_001",
  "pid_file": <PIDå›¾PDF>,
  "bom_file": <BOM Excel>,
  "assembly_file": <è£…é…å›¾STEP>
}

åŠŸèƒ½ï¼š
1. è§£æPIDæå–å·¥å†µå‚æ•°ï¼ˆDN, å‹åŠ›, æµé‡ï¼‰
2. è§£æBOMæå–é›¶ä»¶è§„æ ¼
3. è§£æSTEPæå–è£…é…å…³ç³»
4. å…³è”ä¸‰è€…æ•°æ®
5. æå–ä¸‰ç±»çŸ¥è¯†ï¼ˆé€‰å‹ã€é…å¥—ã€è£…é…ï¼‰
```

#### 1.2 åˆ›å»ºé€‰å‹çŸ¥è¯†æå–å™¨
```python
# apps/api/src/services/learning/SelectionRuleExtractor.py

class SelectionRuleExtractor:
    """
    ä»PID+BOMä¸­æå–é€‰å‹è§„åˆ™
    """

    def extract_selection_rules(self, pid_data, bom_data):
        """
        æå–é€‰å‹è§„åˆ™

        è¾“å…¥ï¼š
        - pid_data: PIDè§£æç»“æœï¼ˆç®¡é“ã€è®¾å¤‡ã€å‚æ•°ï¼‰
        - bom_data: BOMé›¶ä»¶æ¸…å•

        è¾“å‡ºï¼š
        - é€‰å‹è§„åˆ™åˆ—è¡¨
        """
        rules = []

        # 1. å£å¾„åŒ¹é…è§„åˆ™
        rules.extend(self._extract_dn_rules(pid_data, bom_data))

        # 2. å‹åŠ›ç­‰çº§è§„åˆ™
        rules.extend(self._extract_pressure_rules(pid_data, bom_data))

        # 3. æµé‡åŒ¹é…è§„åˆ™
        rules.extend(self._extract_flow_rules(pid_data, bom_data))

        # 4. æè´¨é€‰æ‹©è§„åˆ™
        rules.extend(self._extract_material_rules(pid_data, bom_data))

        return rules

    def _extract_dn_rules(self, pid_data, bom_data):
        """æå–å£å¾„åŒ¹é…è§„åˆ™"""
        rules = []

        # æ‰¾åˆ°PIDä¸­çš„ç®¡é“
        for pipe in pid_data.get('pipes', []):
            pipe_dn = pipe.get('dn')
            if not pipe_dn:
                continue

            # æ‰¾åˆ°è¿æ¥åˆ°è¿™ä¸ªç®¡é“çš„é˜€é—¨
            connected_valves = self._find_connected_valves(pipe, pid_data, bom_data)

            for valve in connected_valves:
                valve_dn = self._extract_dn(valve.specification)

                if pipe_dn == valve_dn:
                    rules.append({
                        'rule_type': 'selection',
                        'condition': {
                            'type': 'pipe_dn_match',
                            'pid_element': 'pipe',
                            'pid_dn': pipe_dn
                        },
                        'action': {
                            'select_part_type': valve.type,
                            'select_dn': valve_dn
                        },
                        'confidence': 0.9,
                        'reasoning': f'ç®¡é“DN{pipe_dn}é€‰æ‹©DN{valve_dn}é˜€é—¨'
                    })

        return rules
```

#### 1.3 åˆ›å»ºé…å¥—è§„åˆ™æå–å™¨
```python
# apps/api/src/services/learning/MatchingRuleExtractor.py

class MatchingRuleExtractor:
    """
    ä»BOMä¸­æå–é…å¥—è§„åˆ™
    """

    def extract_matching_rules(self, bom_samples):
        """
        ä»å¤šä¸ªBOMæ ·æœ¬ä¸­æå–é…å¥—è§„åˆ™

        è¾“å…¥ï¼š
        - bom_samples: å¤šä¸ªBOMæ¸…å•çš„åˆ—è¡¨

        è¾“å‡ºï¼š
        - é…å¥—è§„åˆ™åˆ—è¡¨
        """
        # ç»Ÿè®¡é›¶ä»¶å…±ç°æ¨¡å¼
        co_occurrence = defaultdict(lambda: {'count': 0, 'examples': []})

        for bom in bom_samples:
            # æ‰¾å‡ºè§„æ ¼ç›¸åŒçš„é›¶ä»¶å¯¹
            for i, part_a in enumerate(bom):
                for part_b in bom[i+1:]:
                    # æ£€æŸ¥DNåŒ¹é…
                    dn_a = self._extract_dn(part_a.specification)
                    dn_b = self._extract_dn(part_b.specification)

                    if dn_a and dn_b and dn_a == dn_b:
                        key = (part_a.main_type, part_b.main_type, f'DN{dn_a}')
                        co_occurrence[key]['count'] += 1
                        co_occurrence[key]['examples'].append({
                            'part_a': part_a.name,
                            'part_b': part_b.name
                        })

        # ç”Ÿæˆè§„åˆ™
        rules = []
        for (type_a, type_b, spec), data in co_occurrence.items():
            if data['count'] >= 3:  # è‡³å°‘3ä¸ªæ ·æœ¬
                rules.append({
                    'rule_type': 'matching',
                    'rule_name': f'{type_a}ä¸{type_b}{spec}é…å¥—è§„åˆ™',
                    'condition': {
                        'selected_part_type': type_a,
                        'selected_spec': spec
                    },
                    'action': {
                        'must_select_part_type': type_b,
                        'matching_spec': spec
                    },
                    'confidence': min(0.9, 0.5 + data['count'] * 0.1),
                    'sample_count': data['count'],
                    'examples': data['examples'][:3]
                })

        return rules
```

### Phase 2: åº”ç”¨é˜¶æ®µï¼ˆ2å‘¨ï¼‰

**ç›®æ ‡ï¼šä»æ–°PIDè‡ªåŠ¨é€‰å‹å’Œè£…é…**

#### 2.1 PIDè§£ææœåŠ¡ï¼ˆå·²æœ‰ï¼Œéœ€å¢å¼ºï¼‰
```javascript
// å¢å¼ºç°æœ‰ PIDRecognitionService
// ä¸ä»…è¯†åˆ«è®¾å¤‡ï¼Œè¿˜è¦æå–å‚æ•°

class PIDRecognitionService {
    recognizePID(pidFile) {
        return {
            devices: [
                {
                    type: 'æ³µ',
                    tag: 'P-101',
                    parameters: {
                        flow: 100,  // mÂ³/h
                        head: 50    // m
                    }
                },
                {
                    type: 'é˜€é—¨',
                    tag: 'V-101',
                    connected_pipe: 'L-001'
                }
            ],
            pipes: [
                {
                    tag: 'L-001',
                    dn: 50,
                    pressure: 16,  // bar
                    fluid: 'æ°´'
                }
            ]
        }
    }
}
```

#### 2.2 è‡ªåŠ¨é€‰å‹æœåŠ¡
```javascript
// apps/api/src/services/selection/AutoSelectionService.js

class AutoSelectionService {
    /**
     * æ ¹æ®PIDè‡ªåŠ¨é€‰å‹
     */
    async selectParts(pidData) {
        const selectedParts = []
        const selectionRules = await this.loadSelectionRules()

        // 1. ä¸ºæ¯ä¸ªPIDè®¾å¤‡é€‰æ‹©é›¶ä»¶
        for (const device of pidData.devices) {
            // æŸ¥è¯¢é€‰å‹è§„åˆ™
            const applicableRules = selectionRules.filter(rule =>
                this.matchCondition(rule.condition, device, pidData)
            )

            // åº”ç”¨è§„åˆ™é€‰æ‹©é›¶ä»¶
            for (const rule of applicableRules) {
                const part = {
                    type: rule.action.select_part_type,
                    specification: this.buildSpecification(rule.action, device),
                    source_rule: rule.rule_id,
                    confidence: rule.confidence
                }
                selectedParts.push(part)
            }
        }

        // 2. æ ¹æ®é…å¥—è§„åˆ™è¡¥å……é›¶ä»¶
        const matchingRules = await this.loadMatchingRules()
        const additionalParts = this.applyMatchingRules(selectedParts, matchingRules)

        return {
            primary_parts: selectedParts,
            additional_parts: additionalParts,
            total_parts: selectedParts.length + additionalParts.length
        }
    }

    matchCondition(condition, device, pidData) {
        if (condition.type === 'pipe_dn_match') {
            // æ‰¾åˆ°è®¾å¤‡è¿æ¥çš„ç®¡é“
            const pipe = pidData.pipes.find(p =>
                p.tag === device.connected_pipe
            )
            return pipe && pipe.dn === condition.pid_dn
        }

        // ...æ›´å¤šæ¡ä»¶åŒ¹é…é€»è¾‘
    }
}
```

#### 2.3 å®Œæ•´æµç¨‹API
```javascript
// apps/api/src/routes/assembly.js

/**
 * PID â†’ è‡ªåŠ¨é€‰å‹ â†’ è‡ªåŠ¨è£…é… å®Œæ•´æµç¨‹
 */
router.post('/pid-to-assembly-complete', authenticate, async (req, res) => {
    try {
        const { pidFile } = req.files

        // 1. PIDè¯†åˆ«
        const pidData = await pidRecognitionService.recognize(pidFile)

        // 2. è‡ªåŠ¨é€‰å‹
        const selectionResult = await autoSelectionService.selectParts(pidData)

        // 3. ç”ŸæˆBOM
        const bom = selectionResult.primary_parts.concat(selectionResult.additional_parts)

        // 4. è‡ªåŠ¨è£…é…ï¼ˆä½¿ç”¨è£…é…è§„åˆ™ï¼‰
        const assemblyResult = await assemblyReasoningService.inferConstraints(
            bom,  // è‡ªåŠ¨ç”Ÿæˆçš„BOM
            [],   // æš‚æ— STEPï¼ˆé¦–æ¬¡è®¾è®¡ï¼‰
            req.user.id
        )

        // 5. ç”Ÿæˆ3Dæ¨¡å‹
        const modelResult = await assembly3DService.generate(assemblyResult.constraints)

        res.json({
            success: true,
            pid_recognition: pidData,
            auto_selection: selectionResult,
            bom: bom,
            assembly_constraints: assemblyResult.constraints,
            model_preview: modelResult.preview_url
        })

    } catch (error) {
        res.status(500).json({
            success: false,
            error: error.message
        })
    }
})
```

---

## ğŸ“Š æ•ˆæœæ¼”ç¤º

### å­¦ä¹ é˜¶æ®µ

**è¾“å…¥ï¼š15ä¸ªå†å²å·¥ç¨‹æ¡ˆä¾‹**
```
æ¡ˆä¾‹1: PID(ç®¡é“DN50,16bar) + BOM(DN50çƒé˜€,PN16æ³•å…°) + STEP
æ¡ˆä¾‹2: PID(ç®¡é“DN80,25bar) + BOM(DN80çƒé˜€,PN25æ³•å…°) + STEP
...
æ¡ˆä¾‹15: ...
```

**å­¦åˆ°çš„çŸ¥è¯†ï¼š**
```json
{
  "selection_rules": [
    {
      "rule": "ç®¡é“DN50 â†’ é€‰DN50é˜€é—¨",
      "confidence": 0.95,
      "samples": 12
    },
    {
      "rule": "å‹åŠ›16bar â†’ é€‰PN16é›¶ä»¶",
      "confidence": 0.93,
      "samples": 10
    },
    {
      "rule": "æµé‡100mÂ³/h â†’ é€‰50-200/15æ³µ",
      "confidence": 0.85,
      "samples": 5
    }
  ],
  "matching_rules": [
    {
      "rule": "DN50é˜€é—¨ â†’ å¿…é…DN50æ³•å…°",
      "confidence": 0.98,
      "samples": 15
    },
    {
      "rule": "DN50æ³•å…° â†’ éœ€M8èºæ “Ã—4",
      "confidence": 0.92,
      "samples": 13
    }
  ],
  "assembly_rules": [
    {
      "rule": "é˜€é—¨+æ³•å…° â†’ SCREW(5mm,4èºæ “)",
      "confidence": 0.95,
      "samples": 15
    }
  ]
}
```

### åº”ç”¨é˜¶æ®µ

**è¾“å…¥ï¼šæ–°çš„PIDå›¾**
```
PIDå†…å®¹ï¼š
  - ç®¡é“L-001: DN50, 16bar, æ°´
  - é˜€é—¨V-101: ä½äºL-001ä¸Š
  - æ³µP-101: æµé‡100mÂ³/h
```

**è‡ªåŠ¨é€‰å‹ç»“æœï¼š**
```json
{
  "auto_selection": [
    {
      "part": "çƒé˜€",
      "specification": "DN50 PN16",
      "reason": "åŒ¹é…è§„åˆ™ï¼šç®¡é“DN50â†’é€‰DN50é˜€é—¨ï¼Œå‹åŠ›16barâ†’é€‰PN16",
      "confidence": 0.95
    },
    {
      "part": "æ³•å…°",
      "specification": "DN50 PN16",
      "reason": "é…å¥—è§„åˆ™ï¼šDN50é˜€é—¨å¿…é…DN50æ³•å…°",
      "confidence": 0.98
    },
    {
      "part": "M8èºæ “",
      "quantity": 4,
      "reason": "é…å¥—è§„åˆ™ï¼šDN50æ³•å…°éœ€M8èºæ “Ã—4",
      "confidence": 0.92
    },
    {
      "part": "ç¦»å¿ƒæ³µ",
      "model": "50-200/15",
      "reason": "æµé‡100mÂ³/håŒ¹é…æ³µå‹å·",
      "confidence": 0.85
    }
  ],
  "generated_bom": [
    "V-101: çƒé˜€ DN50 PN16 Ã—1",
    "F-101: æ³•å…° DN50 PN16 Ã—2",
    "B-101: M8èºæ “ Ã—8",
    "P-101: ç¦»å¿ƒæ³µ 50-200/15 Ã—1"
  ]
}
```

**è‡ªåŠ¨è£…é…ç»“æœï¼š**
```json
{
  "assembly_constraints": [
    {
      "part_a": "çƒé˜€V-101",
      "part_b": "æ³•å…°F-101",
      "constraint": "SCREW",
      "distance_mm": 5,
      "bolt_count": 4,
      "reason": "è£…é…è§„åˆ™ï¼šé˜€é—¨+æ³•å…°èºæ “è¿æ¥",
      "confidence": 0.95
    }
  ],
  "3d_model": "assembly_001.step"
}
```

---

## âœ… æ€»ç»“

### èƒ½å­¦åˆ°çš„çŸ¥è¯†

| çŸ¥è¯†ç±»å‹ | ç°çŠ¶ | ä¿®å¤å |
|---------|-----|--------|
| è£…é…è§„åˆ™ | âœ… èƒ½å­¦ | âœ… èƒ½å­¦ï¼ˆæ›´å¥½ï¼‰ |
| é€‰å‹è§„åˆ™ | âŒ ä¸èƒ½å­¦ | âœ… **èƒ½å­¦**ï¼ˆæ–°å¢ï¼‰ |
| é…å¥—è§„åˆ™ | âŒ ä¸èƒ½å­¦ | âœ… **èƒ½å­¦**ï¼ˆæ–°å¢ï¼‰ |

### èƒ½å›ç­”çš„é—®é¢˜

| é—®é¢˜ | ç°çŠ¶ | ä¿®å¤å |
|-----|-----|--------|
| "ä¸ºä»€ä¹ˆé€‰DN50ï¼Ÿ" | âŒ ä¸çŸ¥é“ | âœ… **"å› ä¸ºç®¡é“æ˜¯DN50"** |
| "ä¸ºä»€ä¹ˆé€‰PN16ï¼Ÿ" | âŒ ä¸çŸ¥é“ | âœ… **"å› ä¸ºå‹åŠ›æ˜¯16bar"** |
| "ä¸ºä»€ä¹ˆé…DN50æ³•å…°ï¼Ÿ" | âŒ ä¸çŸ¥é“ | âœ… **"å› ä¸ºé˜€é—¨æ˜¯DN50"** |
| "ä¸ºä»€ä¹ˆ4ä¸ªèºæ “ï¼Ÿ" | âŒ ä¸çŸ¥é“ | âœ… **"DN50æ³•å…°æ ‡å‡†é…ç½®"** |
| "ä¸‹æ¬¡èƒ½è‡ªåŠ¨é€‰å‹å—ï¼Ÿ" | âŒ ä¸èƒ½ | âœ… **èƒ½ï¼** |

### å®æ–½æ—¶é—´

- **Phase 1** (å­¦ä¹ èƒ½åŠ›): 2å‘¨
- **Phase 2** (åº”ç”¨èƒ½åŠ›): 2å‘¨
- **æ€»è®¡**: 4å‘¨å®Œæ•´å®ç°

---

## ğŸš€ ç«‹å³å¼€å§‹ï¼Ÿ

æˆ‘å»ºè®®ä»**Phase 1å¼€å§‹**ï¼Œå…ˆè®©ç³»ç»Ÿèƒ½å¤Ÿå­¦ä¹ é€‰å‹çŸ¥è¯†ã€‚

éœ€è¦æˆ‘ç«‹å³å®æ–½å—ï¼Ÿ

---

## ğŸ”§ å…³é”®é—®é¢˜ï¼šè¿æ¥ä»¶å’Œè¾…åŠ©ä»¶å¦‚ä½•é€‰æ‹©ï¼Ÿ

### æ‚¨çš„è¿½é—®

> "è¿æ¥ä»¶ï¼ˆèºæ “ã€å«ç‰‡ï¼‰å’Œç®¡çº¿ï¼Œè¿™äº›PIDå›¾ä¸Šæ˜¯æ²¡æœ‰çš„ï¼Œæˆ‘ä»¬çŸ¥é“è¦æ‰¾ä»€ä¹ˆæ ·çš„ä»¶å—ï¼Ÿ"

**æ ¸å¿ƒçŸ›ç›¾ï¼š**
- PIDå›¾åªæ ‡æ³¨**ä¸»è®¾å¤‡**ï¼ˆæ³µã€é˜€é—¨ã€ç½ä½“ï¼‰å’Œ**ç®¡çº¿å‚æ•°**ï¼ˆDNã€å‹åŠ›ï¼‰
- ä½†è£…é…éœ€è¦å¤§é‡**è¿æ¥ä»¶**ï¼ˆæ³•å…°ã€èºæ “ã€å«ç‰‡ï¼‰å’Œ**è¾…åŠ©ä»¶**ï¼ˆæ”¯æ¶ã€å¯†å°åœˆï¼‰
- è¿™äº›åœ¨PIDå›¾ä¸Š**æ²¡æœ‰æ ‡æ³¨**

---

### è§£å†³æ–¹æ¡ˆï¼šé…å¥—è§„åˆ™åº“

**å…³é”®æ€æƒ³ï¼šä»ä¸»é›¶ä»¶æ¨å¯¼è¾…åŠ©é›¶ä»¶**

```
PIDå›¾å‘Šè¯‰æˆ‘ä»¬ä¸»è®¾å¤‡ï¼š
â”œâ”€ çƒé˜€ï¼ˆä½†ä¸çŸ¥é“éœ€è¦æ³•å…°ï¼‰
â”œâ”€ ç®¡é“DN50ï¼ˆä½†ä¸çŸ¥é“éœ€è¦æ³•å…°ã€æ”¯æ¶ï¼‰
â””â”€ æ³µï¼ˆä½†ä¸çŸ¥é“éœ€è¦åº•åº§ã€è”è½´å™¨ï¼‰

é€šè¿‡å­¦ä¹ ï¼Œç³»ç»ŸçŸ¥é“ï¼š
â”œâ”€ "é€‰äº†çƒé˜€" â†’ è‡ªåŠ¨é…å¥—"æ³•å…°Ã—2"
â”œâ”€ "é€‰äº†æ³•å…°DN50" â†’ è‡ªåŠ¨é…å¥—"M8èºæ “Ã—4 + DN50å«ç‰‡Ã—1"
â”œâ”€ "é€‰äº†ç®¡é“DN50" â†’ è‡ªåŠ¨é…å¥—"ç®¡å¡ + æ”¯æ¶ï¼ˆæ¯3ç±³ï¼‰"
â””â”€ "é€‰äº†æ³µ" â†’ è‡ªåŠ¨é…å¥—"åº•åº§ + åœ°è„šèºæ “ + è”è½´å™¨"
```

---

### ç¤ºä¾‹ï¼šä»PIDåˆ°å®Œæ•´BOM

#### PIDå›¾å†…å®¹ï¼ˆç®€åŒ–ï¼‰

```
PIDæ ‡æ³¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L-001: DN50, 16bar, æ°´            â”‚
â”‚         â†“                          â”‚
â”‚  [V-101]  çƒé˜€                     â”‚
â”‚         â†“                          â”‚
â”‚  L-002: DN50, 16bar                â”‚
â”‚         â†“                          â”‚
â”‚  [P-101]  ç¦»å¿ƒæ³µ, 100mÂ³/h          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PIDä¸Šåªæœ‰ï¼š
âœ… ç®¡çº¿æ ‡è¯† (L-001, L-002)
âœ… ç®¡çº¿å‚æ•° (DN50, 16bar)
âœ… ä¸»è®¾å¤‡ (é˜€é—¨ã€æ³µ)
âœ… å·¥å†µå‚æ•° (æµé‡)

PIDä¸Šæ²¡æœ‰ï¼š
âŒ æ³•å…°
âŒ èºæ “
âŒ å«ç‰‡
âŒ æ”¯æ¶
âŒ ç®¡ä»¶ï¼ˆå¼¯å¤´ã€ä¸‰é€šï¼‰
```

#### ç¬¬1æ­¥ï¼šPIDè¯†åˆ« + åˆæ­¥é€‰å‹

```
ç³»ç»Ÿè¯†åˆ«ï¼š
  - è®¾å¤‡ï¼šçƒé˜€V-101
  - è®¾å¤‡ï¼šç¦»å¿ƒæ³µP-101
  - ç®¡é“ï¼šL-001 (DN50, 16bar)
  - ç®¡é“ï¼šL-002 (DN50, 16bar)

åˆæ­¥é€‰å‹ï¼ˆä½¿ç”¨é€‰å‹è§„åˆ™ï¼‰ï¼š
  âœ… V-101: çƒé˜€ DN50 PN16 Ã—1
  âœ… P-101: ç¦»å¿ƒæ³µ 50-200/15 Ã—1
  âœ… L-001ç®¡é“: ç›´ç®¡DN50 PN16 Ã—5mï¼ˆä¼°ç®—ï¼‰
  âœ… L-002ç®¡é“: ç›´ç®¡DN50 PN16 Ã—3mï¼ˆä¼°ç®—ï¼‰
```

æ­¤æ—¶BOMè¿˜ä¸å®Œæ•´ï¼Œç¼ºå°‘è¿æ¥ä»¶ï¼

#### ç¬¬2æ­¥ï¼šé…å¥—è§„åˆ™è¡¥å……

**è§„åˆ™1ï¼šé˜€é—¨éœ€è¦æ³•å…°**
```
IF é€‰æ‹©äº†"çƒé˜€ DN50"
THEN å¿…é¡»é…å¥—ï¼š
  - æ³•å…° DN50 PN16 Ã—2  (é˜€é—¨ä¸¤ç«¯)
  - ç†ç”±ï¼šé˜€é—¨æ³•å…°è¿æ¥æ ‡å‡†é…ç½®
  - ç½®ä¿¡åº¦ï¼š0.98 (ä»15ä¸ªæ¡ˆä¾‹ä¸­å­¦åˆ°ï¼Œ100%å‡ºç°)
```

**è§„åˆ™2ï¼šæ³•å…°éœ€è¦èºæ “å’Œå«ç‰‡**
```
IF é€‰æ‹©äº†"æ³•å…° DN50 PN16"
THEN å¿…é¡»é…å¥—ï¼š
  - M8èºæ “ Ã—4  (æ¯ä¸ªæ³•å…°è¿æ¥)
  - M8èºæ¯ Ã—4
  - DN50å«ç‰‡ Ã—1
  - ç†ç”±ï¼šDN50æ³•å…°æ ‡å‡†é…ç½®ï¼ˆå›½æ ‡/ä»å†å²å­¦ä¹ ï¼‰
  - ç½®ä¿¡åº¦ï¼š0.95
```

**è§„åˆ™3ï¼šæ³µéœ€è¦åº•åº§å’Œè”è½´å™¨**
```
IF é€‰æ‹©äº†"ç¦»å¿ƒæ³µ 50-200/15"
THEN å¿…é¡»é…å¥—ï¼š
  - æ³µåº•åº§ Ã—1
  - åœ°è„šèºæ “M16 Ã—4
  - è”è½´å™¨ Ã—1
  - æ³•å…°DN50 Ã—2  (æ³µè¿›å‡ºå£)
  - ç†ç”±ï¼šæ³µçš„æ ‡å‡†å®‰è£…é…ç½®
  - ç½®ä¿¡åº¦ï¼š0.92
```

**è§„åˆ™4ï¼šç®¡é“éœ€è¦æ”¯æ¶**
```
IF é€‰æ‹©äº†"ç®¡é“ DN50, é•¿åº¦8m"
THEN å¿…é¡»é…å¥—ï¼š
  - ç®¡å¡DN50 Ã—3  (æ¯3ç±³ä¸€ä¸ª)
  - Uå‹æ”¯æ¶ Ã—3
  - è†¨èƒ€èºæ “M10 Ã—12  (æ¯ä¸ªæ”¯æ¶4ä¸ª)
  - ç†ç”±ï¼šç®¡é“æ”¯æ’‘æ ‡å‡†è¦æ±‚
  - ç½®ä¿¡åº¦ï¼š0.90
```

#### ç¬¬3æ­¥ï¼šå®Œæ•´BOMæ¸…å•

```
åº”ç”¨é…å¥—è§„åˆ™åï¼Œç”Ÿæˆå®Œæ•´BOMï¼š

ã€ä¸»è®¾å¤‡ã€‘(PIDä¸Šæœ‰çš„)
  âœ… V-101: çƒé˜€ DN50 PN16                Ã—1

ã€ç®¡é“ç³»ç»Ÿã€‘(PIDä¸Šæœ‰çš„)
  âœ… L-001: ç›´ç®¡ DN50 PN16, 5m            Ã—1
  âœ… L-002: ç›´ç®¡ DN50 PN16, 3m            Ã—1

ã€æ³µç³»ç»Ÿã€‘(PIDä¸Šæœ‰çš„)
  âœ… P-101: ç¦»å¿ƒæ³µ 50-200/15             Ã—1

ã€æ³•å…°ã€‘(é…å¥—è¡¥å……)
  ğŸ”§ F-001: æ³•å…° DN50 PN16              Ã—2  (é˜€é—¨é…å¥—)
  ğŸ”§ F-002: æ³•å…° DN50 PN16              Ã—2  (æ³µé…å¥—)
  ğŸ”§ F-003: æ³•å…° DN50 PN16              Ã—2  (ç®¡é“è¿æ¥)

ã€èºæ “/èºæ¯ã€‘(é…å¥—è¡¥å……)
  ğŸ”§ B-001: M8å…­è§’èºæ “, L=60mm          Ã—24 (6ä¸ªæ³•å…°Ã—4)
  ğŸ”§ N-001: M8å…­è§’èºæ¯                  Ã—24
  ğŸ”§ B-002: M16åœ°è„šèºæ “, L=200mm        Ã—4  (æ³µåº•åº§)

ã€å«ç‰‡ã€‘(é…å¥—è¡¥å……)
  ğŸ”§ G-001: DN50çŸ³æ£‰å«ç‰‡                Ã—6  (6ä¸ªæ³•å…°è¿æ¥)

ã€æ”¯æ¶ç³»ç»Ÿã€‘(é…å¥—è¡¥å……)
  ğŸ”§ S-001: ç®¡å¡DN50                    Ã—3  (8mç®¡é“)
  ğŸ”§ S-002: Uå‹æ”¯æ¶                     Ã—3
  ğŸ”§ S-003: è†¨èƒ€èºæ “M10, L=80mm         Ã—12 (3æ”¯æ¶Ã—4)

ã€æ³µå®‰è£…ã€‘(é…å¥—è¡¥å……)
  ğŸ”§ BASE-001: æ³µåº•åº§                   Ã—1
  ğŸ”§ COUP-001: è”è½´å™¨                   Ã—1

æ€»è®¡ï¼š12ç§ä¸»ä»¶ + è¾…åŠ©ä»¶ï¼Œå…±çº¦70ä¸ªé›¶ä»¶
```

---

### é…å¥—è§„åˆ™çš„ä¸¤ç§æ¥æº

#### æ¥æº1ï¼šæ ‡å‡†è§„èŒƒï¼ˆç¡¬ç¼–ç ï¼‰

```javascript
// æ ‡å‡†è§„èŒƒè§„åˆ™ï¼ˆå¯é æ€§é«˜ï¼‰
const STANDARD_RULES = [
    {
        rule_id: 'STD_FLANGE_BOLT_DN50',
        source: 'å›½æ ‡GB/T 9119-2010',
        condition: {
            part_type: 'æ³•å…°',
            dn: 50,
            pn: 16
        },
        action: {
            add_parts: [
                { type: 'M8èºæ “', quantity: 4 },
                { type: 'M8èºæ¯', quantity: 4 },
                { type: 'DN50å«ç‰‡', quantity: 1 }
            ]
        },
        confidence: 1.0  // æ ‡å‡†è§„èŒƒï¼Œ100%å¯ä¿¡
    },

    {
        rule_id: 'STD_PIPE_SUPPORT',
        source: 'HG/T 20593ç®¡é“æ”¯æ¶æ ‡å‡†',
        condition: {
            part_type: 'ç®¡é“',
            dn_min: 40,
            dn_max: 80
        },
        action: {
            add_parts_per_meter: {
                support_interval: 3,  // æ¯3ç±³ä¸€ä¸ªæ”¯æ¶
                parts: [
                    { type: 'ç®¡å¡', spec: 'DN{dn}' },
                    { type: 'Uå‹æ”¯æ¶' },
                    { type: 'è†¨èƒ€èºæ “M10', quantity: 4 }
                ]
            }
        },
        confidence: 1.0
    }
]
```

#### æ¥æº2ï¼šå†å²æ¡ˆä¾‹å­¦ä¹ ï¼ˆæ•°æ®é©±åŠ¨ï¼‰

```python
def learn_matching_rules_from_history(bom_samples):
    """
    ä»å†å²BOMä¸­å­¦ä¹ é…å¥—è§„åˆ™
    
    è¾“å…¥ï¼š15ä¸ªå†å²å·¥ç¨‹çš„BOMæ¸…å•
    è¾“å‡ºï¼šé…å¥—è§„åˆ™
    """
    
    # ç»Ÿè®¡å…±ç°æ¨¡å¼
    co_occurrence = defaultdict(lambda: {'count': 0, 'specs': []})
    
    for bom in bom_samples:
        # æ‰¾å‡ºé˜€é—¨
        valves = [p for p in bom if p.type == 'çƒé˜€']
        
        for valve in valves:
            valve_dn = extract_dn(valve.specification)
            
            # ç»Ÿè®¡è¿™ä¸ªé˜€é—¨å‘¨å›´é…å¥—äº†ä»€ä¹ˆ
            flanges = find_nearby_parts(bom, valve, 'æ³•å…°')
            bolts = find_nearby_parts(bom, valve, 'èºæ “')
            
            if flanges:
                flange_dn = extract_dn(flanges[0].specification)
                if flange_dn == valve_dn:
                    key = f'valve_DN{valve_dn}_needs_flange'
                    co_occurrence[key]['count'] += 1
                    co_occurrence[key]['specs'].append({
                        'flange_count': len(flanges),
                        'flange_spec': flanges[0].specification
                    })
            
            if bolts:
                bolt_thread = extract_thread(bolts[0].specification)
                bolt_count = len(bolts)
                key = f'flange_DN{valve_dn}_needs_bolt_{bolt_thread}'
                co_occurrence[key]['count'] += 1
                co_occurrence[key]['specs'].append({
                    'bolt_count': bolt_count
                })
    
    # ç”Ÿæˆè§„åˆ™
    rules = []
    for key, data in co_occurrence.items():
        if data['count'] >= 5:  # è‡³å°‘5ä¸ªæ ·æœ¬
            # ç»Ÿè®¡æœ€å¸¸è§çš„é…ç½®
            most_common_config = find_most_common(data['specs'])
            
            rules.append({
                'rule_id': f'LEARNED_{key}',
                'source': 'learned_from_history',
                'confidence': min(0.95, 0.6 + data['count'] * 0.05),
                'sample_count': data['count'],
                'config': most_common_config
            })
    
    return rules

# å­¦ä¹ ç»“æœç¤ºä¾‹ï¼š
"""
ä»15ä¸ªæ¡ˆä¾‹ä¸­å­¦åˆ°ï¼š
- çƒé˜€DN50å‡ºç°12æ¬¡ï¼Œæ¯æ¬¡éƒ½é…äº†2ä¸ªDN50æ³•å…° â†’ ç½®ä¿¡åº¦0.95
- DN50æ³•å…°å‡ºç°25æ¬¡ï¼Œå…¶ä¸­23æ¬¡é…äº†4ä¸ªM8èºæ “ â†’ ç½®ä¿¡åº¦0.92
- DN50æ³•å…°å‡ºç°25æ¬¡ï¼Œå…¶ä¸­2æ¬¡é…äº†8ä¸ªM8èºæ “ â†’ ç½®ä¿¡åº¦0.08 (ä¸é‡‡çº³)
"""
```

---

### æ··åˆç­–ç•¥ï¼šæ ‡å‡† + å­¦ä¹ 

```javascript
class MatchingRuleEngine {
    /**
     * åº”ç”¨é…å¥—è§„åˆ™
     * ä¼˜å…ˆä½¿ç”¨æ ‡å‡†è§„èŒƒï¼Œå…¶æ¬¡ä½¿ç”¨å­¦ä¹ è§„åˆ™
     */
    async applyMatchingRules(selectedParts) {
        const additionalParts = []
        
        // 1. åŠ è½½æ ‡å‡†è§„èŒƒè§„åˆ™ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
        const standardRules = await this.loadStandardRules()
        
        // 2. åŠ è½½å­¦ä¹ è§„åˆ™ï¼ˆä½ä¼˜å…ˆçº§ï¼Œä½œä¸ºè¡¥å……ï¼‰
        const learnedRules = await this.loadLearnedRules()
        
        // 3. åˆå¹¶è§„åˆ™ï¼ˆæ ‡å‡†è§„åˆ™è¦†ç›–å­¦ä¹ è§„åˆ™ï¼‰
        const allRules = this.mergeRules(standardRules, learnedRules)
        
        // 4. ä¸ºæ¯ä¸ªå·²é€‰é›¶ä»¶åº”ç”¨é…å¥—è§„åˆ™
        for (const part of selectedParts) {
            const applicableRules = allRules.filter(rule =>
                this.matchCondition(rule.condition, part)
            )
            
            // æŒ‰ç½®ä¿¡åº¦æ’åºï¼ˆæ ‡å‡†è§„åˆ™confidence=1.0ä¼˜å…ˆï¼‰
            applicableRules.sort((a, b) => b.confidence - a.confidence)
            
            // åº”ç”¨è§„åˆ™
            for (const rule of applicableRules) {
                const newParts = this.generateParts(rule.action, part)
                additionalParts.push(...newParts)
            }
        }
        
        return additionalParts
    }
    
    mergeRules(standardRules, learnedRules) {
        // æ ‡å‡†è§„åˆ™ä¼˜å…ˆï¼Œå­¦ä¹ è§„åˆ™ä½œä¸ºè¡¥å……
        const merged = [...standardRules]
        
        for (const learnedRule of learnedRules) {
            // æ£€æŸ¥æ˜¯å¦ä¸æ ‡å‡†è§„åˆ™å†²çª
            const hasConflict = standardRules.some(std =>
                this.isConflicting(std, learnedRule)
            )
            
            if (!hasConflict) {
                merged.push(learnedRule)
            }
        }
        
        return merged
    }
}
```

---

### å®é™…åº”ç”¨ç¤ºä¾‹

#### æ¡ˆä¾‹ï¼šç®¡é“ç³»ç»Ÿè‡ªåŠ¨è¡¥å…¨

**è¾“å…¥ï¼šPIDè¯†åˆ«ç»“æœ**
```json
{
  "devices": [
    {"type": "çƒé˜€", "tag": "V-101", "connected_pipe": "L-001"}
  ],
  "pipes": [
    {
      "tag": "L-001",
      "dn": 50,
      "pressure": 16,
      "length": 8.0,
      "material": "ç¢³é’¢"
    }
  ]
}
```

**æ­¥éª¤1ï¼šåˆæ­¥é€‰å‹ï¼ˆä¸»è®¾å¤‡ï¼‰**
```json
{
  "primary_parts": [
    {
      "part_number": "V-101",
      "type": "çƒé˜€",
      "specification": "DN50 PN16",
      "quantity": 1,
      "source": "pid_device"
    },
    {
      "part_number": "PIPE-001",
      "type": "ç›´ç®¡",
      "specification": "DN50 PN16, L=8000mm",
      "quantity": 1,
      "source": "pid_pipe"
    }
  ]
}
```

**æ­¥éª¤2ï¼šåº”ç”¨é…å¥—è§„åˆ™ï¼ˆè‡ªåŠ¨è¡¥å…¨ï¼‰**
```json
{
  "additional_parts": [
    // è§„åˆ™1ï¼šçƒé˜€éœ€è¦æ³•å…°
    {
      "part_number": "F-101",
      "type": "æ³•å…°",
      "specification": "DN50 PN16 å¯¹ç„Šæ³•å…°",
      "quantity": 2,
      "source_rule": "STD_VALVE_FLANGES",
      "reasoning": "çƒé˜€ä¸¤ç«¯éœ€è¦æ³•å…°è¿æ¥",
      "confidence": 1.0
    },
    
    // è§„åˆ™2ï¼šæ³•å…°éœ€è¦èºæ “
    {
      "part_number": "B-101",
      "type": "å…­è§’èºæ “",
      "specification": "M8Ã—60",
      "quantity": 8,
      "source_rule": "STD_FLANGE_BOLT_DN50",
      "reasoning": "DN50æ³•å…°æ ‡å‡†é…ç½®4èºæ “Ã—2è¿æ¥",
      "confidence": 1.0
    },
    
    // è§„åˆ™3ï¼šæ³•å…°éœ€è¦èºæ¯
    {
      "part_number": "N-101",
      "type": "å…­è§’èºæ¯",
      "specification": "M8",
      "quantity": 8,
      "source_rule": "STD_FLANGE_BOLT_DN50",
      "reasoning": "é…å¥—èºæ “",
      "confidence": 1.0
    },
    
    // è§„åˆ™4ï¼šæ³•å…°éœ€è¦å«ç‰‡
    {
      "part_number": "G-101",
      "type": "å«ç‰‡",
      "specification": "DN50 çŸ³æ£‰æ©¡èƒ¶å«ç‰‡",
      "quantity": 2,
      "source_rule": "STD_FLANGE_GASKET",
      "reasoning": "æ³•å…°å¯†å°",
      "confidence": 1.0
    },
    
    // è§„åˆ™5ï¼šç®¡é“éœ€è¦æ”¯æ¶
    {
      "part_number": "S-101",
      "type": "ç®¡å¡",
      "specification": "DN50 Uå‹ç®¡å¡",
      "quantity": 3,
      "source_rule": "STD_PIPE_SUPPORT",
      "reasoning": "8ç±³ç®¡é“éœ€3ä¸ªæ”¯æ¶(æ¯3ç±³)",
      "confidence": 1.0
    },
    
    {
      "part_number": "S-102",
      "type": "æ”¯æ¶",
      "specification": "Uå‹æ”¯æ¶ DN50",
      "quantity": 3,
      "source_rule": "STD_PIPE_SUPPORT",
      "reasoning": "é…å¥—ç®¡å¡",
      "confidence": 1.0
    },
    
    {
      "part_number": "B-102",
      "type": "è†¨èƒ€èºæ “",
      "specification": "M10Ã—80",
      "quantity": 12,
      "source_rule": "STD_PIPE_SUPPORT",
      "reasoning": "æ”¯æ¶å›ºå®š(æ¯ä¸ªæ”¯æ¶4èºæ “Ã—3)",
      "confidence": 1.0
    }
  ]
}
```

**æœ€ç»ˆå®Œæ•´BOMï¼š**
```
ä¸»è®¾å¤‡ï¼ˆPIDè¯†åˆ«ï¼‰ï¼š
  V-101: çƒé˜€ DN50 PN16                    Ã—1
  PIPE-001: ç›´ç®¡ DN50 PN16, L=8m           Ã—1

è¾…åŠ©ä»¶ï¼ˆé…å¥—è§„åˆ™è‡ªåŠ¨è¡¥å……ï¼‰ï¼š
  F-101: æ³•å…° DN50 PN16                    Ã—2
  B-101: M8Ã—60èºæ “                        Ã—8
  N-101: M8èºæ¯                           Ã—8
  G-101: DN50å«ç‰‡                         Ã—2
  S-101: DN50ç®¡å¡                         Ã—3
  S-102: Uå‹æ”¯æ¶                          Ã—3
  B-102: M10Ã—80è†¨èƒ€èºæ “                   Ã—12

æ€»è®¡ï¼š8ç§é›¶ä»¶ï¼Œå…±39ä¸ª
```

---

## âœ… æ€»ç»“å›ç­”æ‚¨çš„é—®é¢˜

### Q: è¿æ¥ä»¶å’Œç®¡çº¿åœ¨PIDä¸Šæ²¡æœ‰ï¼Œç³»ç»ŸçŸ¥é“è¦æ‰¾ä»€ä¹ˆä»¶å—ï¼Ÿ

**A: çŸ¥é“ï¼é€šè¿‡é…å¥—è§„åˆ™**

1. **æ ‡å‡†è§„èŒƒè§„åˆ™**ï¼ˆç¡¬ç¼–ç ï¼Œ100%å¯ä¿¡ï¼‰
   - å›½æ ‡ï¼šDN50æ³•å…°é…M8èºæ “Ã—4
   - è¡Œä¸šæ ‡å‡†ï¼šç®¡é“æ¯3ç±³ä¸€ä¸ªæ”¯æ¶
   - æœºæ¢°è®¾è®¡æ‰‹å†Œï¼šæ³µéœ€è¦åº•åº§å’Œè”è½´å™¨

2. **å†å²æ¡ˆä¾‹å­¦ä¹ **ï¼ˆæ•°æ®é©±åŠ¨ï¼Œ85-95%ç½®ä¿¡åº¦ï¼‰
   - ä»15ä¸ªæ¡ˆä¾‹å­¦åˆ°ï¼šDN50é˜€é—¨æ€»æ˜¯é…2ä¸ªDN50æ³•å…°
   - ä»20ä¸ªæ¡ˆä¾‹å­¦åˆ°ï¼šDN50æ³•å…°92%çš„æ—¶å€™é…4ä¸ªèºæ “
   - ä»10ä¸ªæ¡ˆä¾‹å­¦åˆ°ï¼šä¸é”ˆé’¢é˜€é—¨é…ä¸é”ˆé’¢æ³•å…°

3. **æ··åˆç­–ç•¥**
   - ä¼˜å…ˆä½¿ç”¨æ ‡å‡†è§„èŒƒï¼ˆé«˜å¯ä¿¡åº¦ï¼‰
   - æ ‡å‡†æœªè¦†ç›–æ—¶ä½¿ç”¨å­¦ä¹ è§„åˆ™
   - å­¦ä¹ è§„åˆ™å¯ä»¥å‘ç°æ–°æ¨¡å¼

**æµç¨‹ï¼š**
```
PIDå›¾ï¼ˆåªæœ‰ä¸»è®¾å¤‡ï¼‰ 
  â†’ é€‰å‹è§„åˆ™ï¼ˆé€‰ä¸»è®¾å¤‡ï¼‰
  â†’ é…å¥—è§„åˆ™ï¼ˆè‡ªåŠ¨è¡¥å……è¿æ¥ä»¶ã€è¾…åŠ©ä»¶ï¼‰
  â†’ å®Œæ•´BOMæ¸…å•
```

è¿™æ ·ï¼Œå³ä½¿PIDå›¾ä¸Šæ²¡æœ‰æ ‡æ³¨èºæ “ã€å«ç‰‡ã€æ”¯æ¶ï¼Œç³»ç»Ÿä¹Ÿèƒ½è‡ªåŠ¨æ¨å¯¼å‡ºæ¥ï¼
