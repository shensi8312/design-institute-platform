# 快速部署指南 - MasterFormat 模板匹配功能

## 一、本次更新内容
- 新增 MasterFormat 模板自动匹配功能
- 3个文件更新：
  - `MasterFormatMatcher.js` (新文件)
  - `TemplateService.js` (修改)
  - `templates.js` (路由文件)

## 二、重要说明
✅ **不需要动数据库**
✅ **不需要重新编译前端**
✅ **只需要替换3个后端文件 + 重启服务**

---

## 三、部署步骤（超简单）

### 步骤1：本地打包
```bash
cd /Users/shenguoli/Documents/projects/design-institute-platform
./quick-update.sh
```
执行后，桌面会出现 `update.tar.gz` 文件

### 步骤2：上传到服务器
```bash
scp ~/Desktop/update.tar.gz aiuser@10.10.19.3:~/
```
输入密码即可

### 步骤3：SSH连接服务器
```bash
ssh aiuser@10.10.19.3
```
输入密码

### 步骤4：在服务器执行
```bash
cd ~/mst-platform
tar xzf ~/update.tar.gz
pm2 restart mst-api
pm2 logs mst-api --lines 20
```

完成！

---

## 四、测试新功能

访问以下接口测试：
```bash
# 获取统计信息
curl http://10.10.19.3:3000/api/templates/masterformat/statistics

# 匹配单个文件
curl -X POST http://10.10.19.3:3000/api/templates/match \
  -H "Content-Type: application/json" \
  -d '{"filename": "033000 FL - Cast-in-Place Concrete.docx"}'
```

---

## 五、以后每次更新怎么办？

### 情况1：只改后端代码（最常见）
```bash
# 本地
./quick-update.sh
scp ~/Desktop/update.tar.gz aiuser@10.10.19.3:~/

# 服务器
ssh aiuser@10.10.19.3
cd ~/mst-platform && tar xzf ~/update.tar.gz && pm2 restart mst-api
```

### 情况2：改了前端
需要重新编译前端：
```bash
cd apps/web
npm run build
scp -r dist/ aiuser@10.10.19.3:~/mst-platform/apps/web/
```

### 情况3：改了数据库
需要执行迁移：
```bash
ssh aiuser@10.10.19.3
cd ~/mst-platform/apps/api
npx knex migrate:latest
```

---

## 六、回滚（如果有问题）

服务器上有自动备份：
```bash
ssh aiuser@10.10.19.3
cd ~/mst-platform/backups
ls -lt  # 查看备份
# 从备份恢复文件
cp backups/20241106/TemplateService.js apps/api/src/services/document/
pm2 restart mst-api
```

---

## 七、常见问题

**Q: 为什么这次不需要动数据库？**
A: 因为只是添加新的代码功能，没有改表结构

**Q: 需要重启Nginx吗？**
A: 不需要，只改了后端代码

**Q: 如果服务起不来怎么办？**
A: 执行 `pm2 logs mst-api` 查看错误日志

**Q: 多久更新一次？**
A: 看需求，有新功能就更新。建议一周集中更新一次。
