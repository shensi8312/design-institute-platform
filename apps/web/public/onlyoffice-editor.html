<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnlyOfficeç¼–è¾‘å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
                'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 16px;
            color: #666;
        }
        #error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 20px;
            background: #fff2f0;
            border: 1px solid #ffccc7;
            border-radius: 4px;
            max-width: 500px;
        }
        #error h3 {
            color: #ff4d4f;
            margin-bottom: 10px;
        }
        #error p {
            color: #595959;
            font-size: 14px;
        }
        #editor {
            width: 100%;
            height: 100vh;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1890ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div>æ­£åœ¨åŠ è½½OnlyOfficeç¼–è¾‘å™¨...</div>
    </div>
    <div id="error" style="display: none;"></div>
    <div id="editor"></div>

    <script>
        console.log('=== OnlyOffice Editor å¼€å§‹åŠ è½½ ===');
        console.log('ğŸ• æ—¶é—´:', new Date().toLocaleString());

        const urlParams = new URLSearchParams(window.location.search);
        const documentId = urlParams.get('documentId');
        const apiUrl = urlParams.get('apiUrl') || 'http://localhost:3000';
        const token = urlParams.get('token');

        console.log('ğŸ“‹ URLå‚æ•°è§£æç»“æœ:');
        console.log('  - documentId:', documentId);
        console.log('  - apiUrl:', apiUrl);
        console.log('  - tokenå­˜åœ¨:', token ? 'yes' : 'no');
        console.log('  - tokenå‰20å­—ç¬¦:', token ? token.substring(0, 20) + '...' : 'N/A');
        console.log('  - å®Œæ•´URL:', window.location.href);

        function showError(title, message) {
            console.error('âŒ é”™è¯¯:', title, message);
            document.getElementById('loading').style.display = 'none';
            const errorDiv = document.getElementById('error');
            errorDiv.innerHTML = `
                <h3>${title}</h3>
                <p>${message}</p>
            `;
            errorDiv.style.display = 'block';
        }

        async function loadEditor() {
            if (!documentId) {
                showError('å‚æ•°é”™è¯¯', 'ç¼ºå°‘æ–‡æ¡£IDå‚æ•°');
                return;
            }

            if (!token) {
                showError('è®¤è¯é”™è¯¯', 'ç¼ºå°‘è®¤è¯ä»¤ç‰Œ');
                return;
            }

            try {
                console.log('ğŸš€ æ­¥éª¤1: å¼€å§‹åŠ è½½OnlyOffice APIè„šæœ¬...');

                // åŠ è½½OnlyOffice APIè„šæœ¬
                const script = document.createElement('script');
                script.src = 'http://localhost:8880/web-apps/apps/api/documents/api.js';

                script.onerror = function() {
                    console.error('âŒ OnlyOffice APIè„šæœ¬åŠ è½½å¤±è´¥');
                    showError('åŠ è½½å¤±è´¥', 'OnlyOfficeæœåŠ¡ä¸å¯ç”¨ï¼Œè¯·ç¡®è®¤æœåŠ¡å·²å¯åŠ¨ (http://localhost:8880)');
                };

                script.onload = async function() {
                    console.log('âœ… OnlyOffice APIè„šæœ¬åŠ è½½æˆåŠŸ');
                    console.log('ğŸ” æ£€æŸ¥ DocsAPI:', typeof DocsAPI, DocsAPI);

                    try {
                        console.log('ğŸš€ æ­¥éª¤2: è·å–ç¼–è¾‘å™¨é…ç½®...');
                        const configUrl = `${apiUrl}/onlyoffice/config/${documentId}`;
                        console.log('ğŸ“¡ è¯·æ±‚URL:', configUrl);
                        console.log('ğŸ”‘ Authorization header:', `Bearer ${token.substring(0, 20)}...`);

                        console.log('â³ å¼€å§‹fetchè¯·æ±‚...');
                        const response = await fetch(configUrl, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        console.log('ğŸ“¥ fetchå“åº”çŠ¶æ€:', response.status, response.statusText);
                        console.log('ğŸ“¥ å“åº”headers:', Object.fromEntries(response.headers.entries()));

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('âŒ å“åº”é”™è¯¯æ–‡æœ¬:', errorText);
                            throw new Error(`é…ç½®è·å–å¤±è´¥: ${response.status} ${response.statusText}`);
                        }

                        const result = await response.json();
                        console.log('ğŸ“¦ é…ç½®å“åº”JSON:', result);

                        if (!result.success) {
                            throw new Error(result.message || 'é…ç½®è·å–å¤±è´¥');
                        }

                        const config = result.data;
                        console.log('âœ… ç¼–è¾‘å™¨é…ç½®:', config);
                        console.log('ğŸ“„ æ–‡æ¡£URL:', config.document.url);
                        console.log('ğŸ”‘ æ–‡æ¡£Key:', config.document.key);
                        console.log('ğŸ”™ å›è°ƒURL:', config.editorConfig.callbackUrl);

                        console.log('ğŸš€ æ­¥éª¤3: åˆå§‹åŒ–OnlyOfficeç¼–è¾‘å™¨...');

                        // åˆå§‹åŒ–ç¼–è¾‘å™¨
                        const editor = new DocsAPI.DocEditor('editor', {
                            ...config,
                            events: {
                                onReady: function() {
                                    console.log('âœ…âœ…âœ… OnlyOfficeç¼–è¾‘å™¨åŠ è½½å®Œæˆ!!!');
                                    document.getElementById('loading').style.display = 'none';
                                },
                                onError: function(event) {
                                    console.error('âŒâŒâŒ OnlyOfficeç¼–è¾‘å™¨é”™è¯¯:', event);
                                    console.error('é”™è¯¯ä»£ç :', event.data.errorCode);
                                    console.error('é”™è¯¯æè¿°:', event.data.errorDescription);
                                    console.error('é”™è¯¯è¯¦æƒ…:', JSON.stringify(event.data, null, 2));

                                    const errorMessages = {
                                        '-1': 'æœªçŸ¥é”™è¯¯',
                                        '-2': 'è½¬æ¢è¶…æ—¶',
                                        '-3': 'è½¬æ¢é”™è¯¯',
                                        '-4': 'ä¸‹è½½å¤±è´¥ï¼ˆè¯·æ£€æŸ¥æ–‡ä»¶URLæ˜¯å¦å¯è®¿é—®ï¼‰',
                                        '-5': 'æ–‡ä»¶æŸå',
                                        '-6': 'æ–‡æ¡£æ ¼å¼ä¸æ­£ç¡®',
                                        '-7': 'è¾“å…¥é”™è¯¯',
                                        '-8': 'è¾“å‡ºé”™è¯¯',
                                    };
                                    const message = errorMessages[event.data.errorCode] || event.data.errorDescription || 'æœªçŸ¥é”™è¯¯';
                                    showError(`ç¼–è¾‘å™¨é”™è¯¯ (${event.data.errorCode})`, message);
                                },
                                onWarning: function(event) {
                                    console.warn('âš ï¸ OnlyOfficeè­¦å‘Š:', event.data);
                                },
                                onDocumentStateChange: function(event) {
                                    console.log('ğŸ“ æ–‡æ¡£çŠ¶æ€å˜åŒ–:', event.data);
                                },
                                onRequestSaveAs: function(event) {
                                    console.log('ğŸ’¾ è¯·æ±‚å¦å­˜ä¸º:', event.data);
                                }
                            }
                        });

                        console.log('ğŸ“Œ ç¼–è¾‘å™¨å®ä¾‹å·²åˆ›å»º:', editor);

                    } catch (error) {
                        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                        console.error('é”™è¯¯ç±»å‹:', error.name);
                        console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                        console.error('é”™è¯¯å †æ ˆ:', error.stack);
                        showError('åˆå§‹åŒ–å¤±è´¥', error.message);
                    }
                };

                console.log('ğŸ“¥ æ·»åŠ è„šæœ¬åˆ°DOM...');
                document.body.appendChild(script);

            } catch (error) {
                console.error('âŒ åŠ è½½å¤±è´¥:', error);
                console.error('é”™è¯¯ç±»å‹:', error.name);
                console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                showError('åŠ è½½å¤±è´¥', error.message);
            }
        }

        console.log('ğŸ¬ å¼€å§‹æ‰§è¡Œ loadEditor()...');
        loadEditor();
    </script>
</body>
</html>
