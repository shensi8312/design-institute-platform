require('dotenv').config()

const express = require('express')
const cors = require('cors')
const helmet = require('helmet')
const compression = require('compression')
const morgan = require('morgan')
const path = require('path')

// å¯¼å…¥ä¸­é—´ä»¶
const { errorHandler, notFound } = require('./utils/error')

// å¯¼å…¥è·¯ç”±
const authRoutes = require('./routes/auth')
const userRoutes = require('./routes/users')
const departmentRoutes = require('./routes/departments')
const roleRoutes = require('./routes/roles')
const organizationRoutes = require('./routes/organizations')
const permissionRoutes = require('./routes/permissions')
const projectRoutes = require('./routes/projects')
const knowledgeRoutes = require('./routes/knowledge')
const chatRoutes = require('./routes/chat')
const graphRoutes = require('./routes/graph')
const learningRoutes = require('./routes/learning')
const systemRoutes = require('./routes/system')
const menuRoutes = require('./routes/menus')
const annotationRoutes = require('./routes/annotations')
const logRoutes = require('./routes/logs')
const workflowRoutes = require('./routes/workflow')
const engineRoutes = require('./routes/engines')
const workflowTemplateRoutes = require('./routes/workflowTemplate')
const aiPluginRoutes = require('./routes/ai-plugin')  // AIæ’ä»¶ç»Ÿä¸€æ¥å£

const app = express()

// CORSé…ç½®å¿…é¡»åœ¨å…¶ä»–ä¸­é—´ä»¶ä¹‹å‰
app.use(cors({
  origin: function(origin, callback) {
    // å…è®¸çš„æºåˆ—è¡¨
    const allowedOrigins = [
      'http://localhost:5173',
      'http://localhost:5174',
      'http://localhost:5175',
      'http://localhost:5176',
      'http://localhost:5177',
      'http://localhost:5178',
      'http://localhost:5179',
      'http://localhost:8080', 
      'http://localhost:8082',
      'http://localhost:3000'
    ];
    // å…è®¸æ²¡æœ‰originçš„è¯·æ±‚ï¼ˆæ¯”å¦‚Postmanã€æœ¬åœ°æ–‡ä»¶ï¼‰
    if (!origin) return callback(null, true);
    
    if (allowedOrigins.indexOf(origin) !== -1) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],
  preflightContinue: false,
  optionsSuccessStatus: 204
}))

// åŸºç¡€ä¸­é—´ä»¶
app.use(helmet({
  crossOriginResourcePolicy: false,
})) // å®‰å…¨å¤´è®¾ç½®
app.use(compression()) // å“åº”å‹ç¼©

// è¯·æ±‚æ—¥å¿—
if (process.env.NODE_ENV === 'development') {
  app.use(morgan('dev'))
} else {
  app.use(morgan('combined'))
}

// è¯·æ±‚è§£æ
app.use(express.json({ limit: '10mb' }))
app.use(express.urlencoded({ extended: true, limit: '10mb' }))

// é™æ€æ–‡ä»¶æœåŠ¡
app.use('/uploads', express.static(path.join(__dirname, '../uploads')))

// APIè·¯ç”±å‰ç¼€
const API_PREFIX = process.env.API_PREFIX || '/api'

// å¥åº·æ£€æŸ¥
app.get('/health', (req, res) => {
  res.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    environment: process.env.NODE_ENV,
    version: process.env.npm_package_version || '1.0.0'
  })
})

// APIè·¯ç”±
app.use(`${API_PREFIX}/auth`, authRoutes)
app.use(`${API_PREFIX}/users`, userRoutes)
app.use(`${API_PREFIX}/departments`, departmentRoutes)
app.use(`${API_PREFIX}/roles`, roleRoutes)
app.use(`${API_PREFIX}/organizations`, organizationRoutes)
app.use(`${API_PREFIX}/permissions`, permissionRoutes)
app.use(`${API_PREFIX}/projects`, projectRoutes)
app.use(`${API_PREFIX}/knowledge`, knowledgeRoutes)
app.use(`${API_PREFIX}/chat`, chatRoutes)
app.use(`${API_PREFIX}/graph`, graphRoutes)
app.use(`${API_PREFIX}/workflow`, workflowRoutes)
app.use(`${API_PREFIX}/engines`, engineRoutes)
app.use(`${API_PREFIX}/workflow-template`, workflowTemplateRoutes)

// èŠ‚ç‚¹ç®¡ç†ï¼ˆç»Ÿä¸€çš„èŠ‚ç‚¹ç³»ç»Ÿï¼‰
const nodesRouter = require('./routes/nodes')
app.use(`${API_PREFIX}/nodes`, nodesRouter)

// æ™ºèƒ½èŠå¤©è·¯ç”±ï¼ˆé›†æˆGraphRAGï¼‰
const intelligentChatRoutes = require('./routes/intelligentChat')
app.use(`${API_PREFIX}/intelligent-chat`, intelligentChatRoutes)

// æœåŠ¡å¥åº·æ£€æŸ¥å’Œè¯Šæ–­è·¯ç”±
const serviceHealthRoutes = require('./routes/serviceHealth')
app.use(`${API_PREFIX}/service-health`, serviceHealthRoutes)

// è§„åˆ™å¼•æ“è·¯ç”±
const rulesRoutes = require('./routes/rules')
app.use(`${API_PREFIX}/rules`, rulesRoutes)

// ç©ºé—´å¼•æ“è·¯ç”±
const spatialRoutes = require('./routes/spatial')
app.use(`${API_PREFIX}/spatial`, spatialRoutes)

// AIå®¡æ ¸è·¯ç”±
const auditRoutes = require('./routes/audit')
app.use(`${API_PREFIX}/audit`, auditRoutes)

// è§†è§‰è¯†åˆ«è·¯ç”±ï¼ˆè‰å›¾è½¬3Dï¼‰
const visionRoutes = require('./routes/vision')
app.use(`${API_PREFIX}/vision`, visionRoutes)

// AIæ’ä»¶ç»Ÿä¸€æ¥å£ï¼ˆæ’ä»¶çš„å”¯ä¸€å…¥å£ï¼‰
app.use(`${API_PREFIX}/ai-plugin`, aiPluginRoutes)

// AIå»ºæ¨¡è·¯ç”±ï¼ˆæ”¯æŒè‰å›¾è½¬3Dï¼‰
const aiModelingRoutes = require('./routes/ai-modeling')
app.use(`${API_PREFIX}/ai-modeling`, aiModelingRoutes)

// å¼•æ“ç®¡ç†è·¯ç”±å·²åœ¨ä¸Šé¢æ³¨å†Œï¼Œç§»é™¤é‡å¤çš„

app.use(`${API_PREFIX}/learning`, learningRoutes)
app.use(`${API_PREFIX}/system`, systemRoutes)
app.use(`${API_PREFIX}/menus`, menuRoutes)
app.use(`${API_PREFIX}/annotations`, annotationRoutes)
app.use(`${API_PREFIX}/logs`, logRoutes)

// 404å¤„ç†
app.use(notFound)

// é”™è¯¯å¤„ç†ä¸­é—´ä»¶
app.use(errorHandler)

// åˆå§‹åŒ–å¼•æ“ç³»ç»Ÿ
const { getEngineCore } = require('./core/EngineCore')
const { getWorkflowOrchestrator } = require('./core/WorkflowOrchestrator')
const { registerRulesEngine } = require('./engines/RulesEngineAdapter')
const { registerSimpleTarotEngine } = require('./engines/SimpleTarotEngine')

async function initializeEngineSystem() {
  try {
    console.log('ğŸ”§ æ­£åœ¨åˆå§‹åŒ–å¼•æ“ç³»ç»Ÿ...')
    
    // åˆå§‹åŒ–æ ¸å¿ƒç³»ç»Ÿ
    const engineCore = getEngineCore()
    await engineCore.initialize()
    
    // åˆå§‹åŒ–å·¥ä½œæµç¼–æ’å™¨
    const orchestrator = getWorkflowOrchestrator()
    await orchestrator.initialize()
    
    // ä»æ•°æ®åº“åŠ è½½å·²æ¿€æ´»çš„å¼•æ“
    // å¼•æ“å·²ç»åœ¨ engineCore.initialize() ä¸­ä»æ•°æ®åº“åŠ è½½äº†
    
    // è·å–ç»Ÿè®¡ä¿¡æ¯
    const stats = await engineCore.getStatistics()
    console.log(`ğŸ“Š å¼•æ“ç³»ç»Ÿå°±ç»ª: ${stats.engines.total} ä¸ªå¼•æ“å·²åŠ è½½`)
    
    // å¦‚æœæ²¡æœ‰å¼•æ“ï¼Œæç¤ºç”¨æˆ·å¯ä»¥é€šè¿‡APIæˆ–ç•Œé¢æ·»åŠ 
    if (stats.engines.total === 0) {
      console.log('ğŸ’¡ æç¤º: å½“å‰æ²¡æœ‰æ¿€æ´»çš„å¼•æ“')
      console.log('   å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ·»åŠ å¼•æ“:')
      console.log('   1. POST /api/engines/generate - ä»æ–‡æ¡£ç”Ÿæˆå¼•æ“')
      console.log('   2. POST /api/engines/register - æ³¨å†Œè‡ªå®šä¹‰å¼•æ“')
      console.log('   3. GET /api/engines/marketplace - ä»å¸‚åœºä¸‹è½½å¼•æ“')
    }
    
  } catch (error) {
    console.error('âŒ å¼•æ“ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error)
  }
}

// å¯åŠ¨æœåŠ¡å™¨
const PORT = process.env.PORT || 3000
const HOST = '0.0.0.0'  // ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£ï¼Œå…è®¸è¿œç¨‹è®¿é—®
const server = app.listen(PORT, HOST, async () => {
  console.log(`ğŸš€ æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ`)
  console.log(`ğŸ“ æœ¬åœ°åœ°å€: http://localhost:${PORT}`)
  console.log(`ğŸ“ ç½‘ç»œåœ°å€: http://10.10.6.95:${PORT}`)
  console.log(`ğŸŒ ç¯å¢ƒ: ${process.env.NODE_ENV || 'development'}`)
  
  // åˆå§‹åŒ–å¼•æ“ç³»ç»Ÿ
  await initializeEngineSystem()
  console.log(`ğŸ“¡ APIå‰ç¼€: ${API_PREFIX}`)
  console.log(`ğŸ”Œ WebSocket: ws://localhost:${PORT}/ws/document-process`)
})

// åˆå§‹åŒ–WebSocketæœåŠ¡ï¼ˆæ–‡æ¡£å¤„ç†è¿›åº¦æ¨é€ï¼‰
const DocumentProcessWebSocket = require('./services/document/documentProcessWebSocket')
const wsService = new DocumentProcessWebSocket(server)
console.log('âœ… WebSocketæœåŠ¡å·²å¯åŠ¨')

// ä¼˜é›…å…³é—­
process.on('SIGTERM', () => {
  console.log('ğŸ‘‹ æ”¶åˆ°SIGTERMä¿¡å·ï¼Œå¼€å§‹ä¼˜é›…å…³é—­...')
  server.close(() => {
    console.log('âœ… æœåŠ¡å™¨å·²å…³é—­')
    process.exit(0)
  })
})

// å¯åŠ¨Redisé˜Ÿåˆ—Worker
const { startWorker } = require('./workers/documentWorker')
startWorker()

// å¯åŠ¨GraphRAGè‡ªåŠ¨å¤„ç†æœåŠ¡ï¼ˆè¡¥å……å¤„ç†é—æ¼çš„æ–‡æ¡£ï¼‰
const AutoGraphRAGService = require('./services/knowledge/AutoGraphRAGService')
AutoGraphRAGService.startAutoProcessor()

process.on('SIGINT', () => {
  console.log('ğŸ‘‹ æ”¶åˆ°SIGINTä¿¡å·ï¼Œå¼€å§‹ä¼˜é›…å…³é—­...')
  server.close(() => {
    console.log('âœ… æœåŠ¡å™¨å·²å…³é—­')
    process.exit(0)
  })
})

// æœªæ•è·å¼‚å¸¸å¤„ç†
process.on('uncaughtException', (err) => {
  console.error('ğŸ’¥ æœªæ•è·çš„å¼‚å¸¸:', err)
  process.exit(1)
})

process.on('unhandledRejection', (reason, promise) => {
  console.error('ğŸ’¥ æœªå¤„ç†çš„Promiseæ‹’ç»:', reason)
  console.error('Promise:', promise)
  process.exit(1)
})

module.exports = app